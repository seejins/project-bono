{"version":3,"file":"RaceDetail-R161a881.js","sources":["../../src/components/RaceDetail.tsx"],"sourcesContent":["import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';\nimport logger from '../utils/logger';\nimport { useSearchParams } from 'react-router-dom';\nimport { getApiUrl } from '../utils/api';\nimport clsx from 'clsx';\nimport { Calendar, MapPin, Trophy, Flag, ArrowUp, ArrowDown, Minus, Edit, X } from 'lucide-react';\nimport { F123DataService, F123DriverResult } from '../services/F123DataService';\nimport { getTireCompound } from '../utils/f123DataMapping';\nimport { useAdmin } from '../contexts/AdminContext';\nimport { DashboardPage } from './layout/DashboardPage';\nimport { DashboardTable, type DashboardTableColumn } from './layout/DashboardTable';\n\ntype DriverPenalty = {\n  id: string;\n  driverSessionResultId: string;\n  seconds: number;\n  reason: string | null;\n  createdAt: string;\n  createdBy: string | null;\n  isPending?: boolean;\n  isRemovalPending?: boolean;\n};\n\ntype PendingPenaltyAdd = {\n  id: string;\n  driverSessionResultId: string;\n  seconds: number;\n  reason: string;\n};\n\ntype PendingPenaltyRemoval = {\n  penaltyId: string;\n  driverSessionResultId: string;\n};\n\ntype RaceDriverRow = F123DriverResult & {\n  driver_session_result_id?: string | null;\n  user_id?: string | null;\n  mappedUserId?: string | null;\n  mappedUserName?: string | null;\n  jsonDriverName?: string | null;\n  mappingDriverName?: string | null;\n  json_driver_id?: string | null;\n  jsonDriverId?: string | null;\n  isHumanDriver?: boolean;\n  participantIsAi?: boolean | null;\n  sessionResultId?: string | null;\n  canonicalDriverId?: string | null;\n};\n\ntype DriverMemberOption = {\n  id: string;\n  name: string;\n  number?: number | null;\n  team?: string | null;\n};\n\ninterface RaceDetailProps {\n  raceId: string;\n  onDriverSelect: (driverId: string, raceId: string, initialSessionType?: 'race' | 'qualifying' | 'practice') => void;\n}\n\nexport const RaceDetail: React.FC<RaceDetailProps> = ({ raceId, onDriverSelect }) => {\n  const { isAuthenticated } = useAdmin();\n  const [searchParams, setSearchParams] = useSearchParams();\n  const sessionFromUrl = searchParams.get('session') as 'practice' | 'qualifying' | 'race' | null;\n  const [activeSession, setActiveSession] = useState<'practice' | 'qualifying' | 'race'>(\n    sessionFromUrl && ['practice', 'qualifying', 'race'].includes(sessionFromUrl) ? sessionFromUrl : 'race'\n  );\n  const [raceData, setRaceData] = useState<any>(null);\n  const [drivers, setDrivers] = useState<RaceDriverRow[]>([]);\n  const [sessions, setSessions] = useState<any[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [isEditing, setIsEditing] = useState(false);\n  const [penaltyModalOpen, setPenaltyModalOpen] = useState(false);\n  const [selectedDriver, setSelectedDriver] = useState<RaceDriverRow | null>(null);\n  const [penaltySeconds, setPenaltySeconds] = useState<string>('5');\n  const [penaltyReason, setPenaltyReason] = useState<string>('');\n  const [penaltiesByDriver, setPenaltiesByDriver] = useState<Record<string, DriverPenalty[]>>({});\n  const [pendingPenaltyAdds, setPendingPenaltyAdds] = useState<PendingPenaltyAdd[]>([]);\n  const [pendingPenaltyRemovals, setPendingPenaltyRemovals] = useState<PendingPenaltyRemoval[]>([]);\n  const [driverOptions, setDriverOptions] = useState<DriverMemberOption[]>([]);\n  const driverOptionsLoadedRef = useRef(false);\n  const [driverOptionsLoading, setDriverOptionsLoading] = useState(false);\n  const [mappingBusy, setMappingBusy] = useState<Record<string, boolean>>({});\n  const [mappingErrors, setMappingErrors] = useState<Record<string, string | null>>({});\n  const apiUrl = getApiUrl();\n\n  const normalizePenalties = useCallback((penalties: any, driverSessionResultId: string): DriverPenalty[] => {\n    let list = penalties;\n\n    if (typeof list === 'string') {\n      try {\n        list = JSON.parse(list);\n      } catch {\n        list = [];\n      }\n    }\n\n    if (!Array.isArray(list)) {\n      list = [];\n    }\n\n    return list\n      .map((penalty: any) => ({\n        id: penalty.id,\n        driverSessionResultId,\n        seconds: Number(penalty.seconds) || 0,\n        reason: penalty.reason ?? null,\n        createdAt: penalty.created_at || penalty.createdAt || new Date().toISOString(),\n        createdBy: penalty.created_by ?? penalty.createdBy ?? null\n      }))\n      .sort((a: DriverPenalty, b: DriverPenalty) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\n  }, []);\n\n  useEffect(() => {\n    fetchRaceData();\n  }, [raceId]);\n\n  const fetchDriverOptions = useCallback(async () => {\n    if (driverOptionsLoadedRef.current || driverOptionsLoading) {\n      return;\n    }\n\n    setDriverOptionsLoading(true);\n    try {\n      const response = await fetch(`${apiUrl}/api/drivers`);\n      if (!response.ok) {\n        throw new Error(`Failed to fetch drivers: ${response.status}`);\n      }\n\n      const data = await response.json();\n      const driverList = Array.isArray(data.drivers) ? data.drivers : [];\n      const options: DriverMemberOption[] = driverList.map((driver: any) => ({\n        id: String(driver.id),\n        name: driver.name ?? 'Unknown Driver',\n        number: driver.number ?? null,\n        team: driver.team ?? null,\n      }));\n      setDriverOptions(options);\n      driverOptionsLoadedRef.current = true;\n    } catch (error) {\n      logger.error('Error fetching driver options:', error);\n    } finally {\n      setDriverOptionsLoading(false);\n    }\n  }, [apiUrl, driverOptionsLoading]);\n\n  useEffect(() => {\n    if (!isAuthenticated || !isEditing) {\n      return;\n    }\n    if (driverOptionsLoadedRef.current) {\n      return;\n    }\n    fetchDriverOptions();\n  }, [isAuthenticated, isEditing, fetchDriverOptions]);\n\n  // Memoize session type checks (computed once, reused everywhere)\n  const sessionTypes = useMemo(() => ({\n    hasRace: sessions.some(s => s.sessionType === 10),\n    hasQualifying: sessions.some(s => s.sessionType >= 5 && s.sessionType <= 9),\n    hasPractice: sessions.some(s => s.sessionType >= 1 && s.sessionType <= 4)\n  }), [sessions]);\n\n  // Handle session change - update both state and URL\n  const handleSessionChange = useCallback((session: 'practice' | 'qualifying' | 'race') => {\n    setActiveSession(session);\n    setSearchParams(prev => {\n      const newParams = new URLSearchParams(prev);\n      newParams.set('session', session);\n      return newParams;\n    });\n  }, [setSearchParams]);\n\n  // Restore session from URL on mount\n  useEffect(() => {\n    if (sessionFromUrl && ['practice', 'qualifying', 'race'].includes(sessionFromUrl)) {\n      setActiveSession(sessionFromUrl);\n    }\n  }, [sessionFromUrl]);\n\n  // Set default active session to first available session when sessions load\n  useEffect(() => {\n    if (sessions.length === 0) return;\n    \n    // Use memoized session types\n    const { hasRace, hasQualifying, hasPractice } = sessionTypes;\n    \n    // If current active session doesn't exist, switch to first available\n    if (activeSession === 'race' && !hasRace) {\n      if (hasQualifying) {\n        handleSessionChange('qualifying');\n      } else if (hasPractice) {\n        handleSessionChange('practice');\n      }\n    } else if (activeSession === 'qualifying' && !hasQualifying) {\n      if (hasRace) {\n        handleSessionChange('race');\n      } else if (hasPractice) {\n        handleSessionChange('practice');\n      }\n    } else if (activeSession === 'practice' && !hasPractice) {\n      if (hasRace) {\n        handleSessionChange('race');\n      } else if (hasQualifying) {\n        handleSessionChange('qualifying');\n      }\n    }\n  }, [sessions, activeSession, sessionTypes, handleSessionChange]);\n\n  // Helper function to find matching session based on activeSession\n  // Session types: 1=P1, 2=P2, 3=P3, 4=Short Practice, 5=Q1, 6=Q2, 7=Q3, 8=Short Qualifying, 9=OSQ, 10=Race\n  const findMatchingSession = useCallback((sessions: any[], activeSession: string) => {\n    if (!sessions || sessions.length === 0) {\n      return null;\n    }\n\n    const targetSessionType = activeSession === 'practice' ? [1, 2, 3, 4] : \n                              activeSession === 'qualifying' ? [5, 6, 7, 8, 9] : \n                              [10];\n    \n    // Find the most recent session if multiple exist (prefer later sessions)\n    const matchingSessions = sessions.filter(s => targetSessionType.includes(s.sessionType));\n    return matchingSessions.length > 0 \n      ? matchingSessions.sort((a, b) => (b.sessionType || 0) - (a.sessionType || 0))[0] // Prefer later sessions (Q3 > Q2 > Q1, P3 > P2 > P1)\n      : null;\n  }, []);\n\n  // Memoize the current session to avoid recalculating\n  const currentSession = useMemo(() => findMatchingSession(sessions, activeSession), [sessions, activeSession, findMatchingSession]);\n\n  // Memoize the expensive driver transformation logic\n  const transformedDrivers = useMemo((): RaceDriverRow[] => {\n    if (!currentSession || !currentSession.results) {\n      return [];\n    }\n\n    // Transform the backend data to match F123DriverResult interface\n    // Note: DB already returns sorted by position, no need to sort again\n    return currentSession.results.map((result: any, index: number) => {\n      // Parse additional_data ONCE and reuse\n      let additionalData = null;\n      if (result.additional_data) {\n        additionalData = typeof result.additional_data === 'string' \n          ? JSON.parse(result.additional_data) \n          : result.additional_data;\n      } else if (result.additionalData) {\n        additionalData = typeof result.additionalData === 'string' \n          ? JSON.parse(result.additionalData) \n          : result.additionalData;\n      }\n      \n      // Extract tire visual compound from parsed additional_data\n      let visualTireCompound = null;\n      let raceTiresUsed = null;\n      \n      if (additionalData) {\n        // Get visual tire compound from car-status or tyreVisualCompound\n        if (additionalData.carStatus?.visualTyreCompound || additionalData.carStatus?.['visual-tyre-compound']) {\n          visualTireCompound = additionalData.carStatus.visualTyreCompound || additionalData.carStatus['visual-tyre-compound'];\n        } else if (additionalData.tyreVisualCompound || additionalData['tyre-visual-compound']) {\n          visualTireCompound = additionalData.tyreVisualCompound || additionalData['tyre-visual-compound'];\n        }\n        \n        // Get race tires from final-classification tyre-stints-visual\n        if (additionalData.finalClassification) {\n          const fc = additionalData.finalClassification;\n          if (fc.tyreStintsVisual && Array.isArray(fc.tyreStintsVisual) && fc.tyreStintsVisual.length > 0) {\n            raceTiresUsed = fc.tyreStintsVisual;\n          } else if (fc['tyre-stints-visual'] && Array.isArray(fc['tyre-stints-visual']) && fc['tyre-stints-visual'].length > 0) {\n            raceTiresUsed = fc['tyre-stints-visual'];\n          }\n        }\n        \n        // Also check if it's stored directly in additionalData\n        if (!raceTiresUsed && (additionalData.tyreStintsVisual || additionalData['tyre-stints-visual'])) {\n          const stints = additionalData.tyreStintsVisual || additionalData['tyre-stints-visual'];\n          if (Array.isArray(stints) && stints.length > 0) {\n            raceTiresUsed = stints;\n          }\n        }\n      }\n      \n      const participantData =\n        additionalData?.participantData ||\n        additionalData?.participant_data ||\n        additionalData?.ParticipantData ||\n        null;\n\n      const aiIndicators = [\n        participantData?.['ai-controlled'],\n        participantData?.aiControlled,\n        participantData?.ai_controlled,\n        participantData?.isAiControlled,\n        participantData?.isAI,\n        result.ai_controlled,\n        result.aiControlled,\n        result.is_ai_controlled,\n      ];\n\n      let aiControlled: boolean | null = null;\n      for (const indicator of aiIndicators) {\n        if (indicator === undefined || indicator === null) {\n          continue;\n        }\n        if (typeof indicator === 'boolean') {\n          aiControlled = indicator;\n          break;\n        }\n        if (typeof indicator === 'number') {\n          aiControlled = indicator === 1;\n          break;\n        }\n        if (typeof indicator === 'string') {\n          const normalized = indicator.trim().toLowerCase();\n          if (['true', '1', 'yes', 'y', 'ai'].includes(normalized)) {\n            aiControlled = true;\n            break;\n          }\n          if (['false', '0', 'no', 'n', 'human'].includes(normalized)) {\n            aiControlled = false;\n            break;\n          }\n        }\n      }\n\n      const rawDriverSessionResultId =\n        result?.driver_session_result_id ??\n        result?.driverSessionResultId ??\n        result?.id ??\n        null;\n      const normalizedDriverSessionResultId =\n        rawDriverSessionResultId !== undefined && rawDriverSessionResultId !== null\n          ? String(rawDriverSessionResultId)\n          : null;\n\n      const rawSessionResultId =\n        result?.session_result_id ??\n        result?.sessionResultId ??\n        null;\n      const normalizedSessionResultId =\n        rawSessionResultId !== undefined && rawSessionResultId !== null\n          ? String(rawSessionResultId)\n          : null;\n\n      const mappedUserId = result.user_id ? String(result.user_id) : null;\n      const mappedUserName = result.driver_name || null;\n      const jsonDriverName = result.json_driver_name || null;\n      const fallbackMappingName = result.mapping_driver_name || null;\n      const jsonDriverId = result.json_driver_id ? String(result.json_driver_id) : null;\n      const rawDriverId = result.driver_id ?? result.driverId ?? null;\n      const normalizedDriverId = rawDriverId !== undefined && rawDriverId !== null ? String(rawDriverId) : null;\n      const canonicalDriverId =\n        mappedUserId ??\n        jsonDriverId ??\n        normalizedDriverId ??\n        (result.member_id ? String(result.member_id) : null) ??\n        (result.player_id ? String(result.player_id) : null) ??\n        (result.driver_number != null ? `car-${result.driver_number}` : null);\n      // Prioritize driver_session_result_id first (unique per result)\n      const normalizedResultId =\n        normalizedDriverSessionResultId ??\n        (result?.id !== undefined && result?.id !== null ? String(result.id) : null) ??\n        normalizedSessionResultId;\n      const preferredDisplayName =\n        mappedUserName || jsonDriverName || fallbackMappingName || 'Unknown Driver';\n      const isHumanDriver = aiControlled === null ? Boolean(mappedUserId) : !aiControlled;\n      \n      const driver: any = {\n        // driver.id MUST be driver_session_result_id (unique per result)\n        id:\n          normalizedDriverSessionResultId ??\n          normalizedResultId ??\n          `driver-${normalizedDriverSessionResultId ?? index}`,\n        driver_session_result_id: normalizedDriverSessionResultId,\n        user_id: result.user_id, // Tournament participant/user (NULL until mapped)\n        json_driver_id: result.json_driver_id ? String(result.json_driver_id) : null, // In-game driver ID from column\n        mappedUserId,\n        mappedUserName,\n        jsonDriverName,\n        mappingDriverName: fallbackMappingName,\n        isHumanDriver,\n        participantIsAi: aiControlled,\n        sessionResultId: normalizedResultId ?? normalizedSessionResultId ?? null,\n        canonicalDriverId: canonicalDriverId ?? null,\n        name: preferredDisplayName,\n        team: result.json_team_name || result.mapping_team_name || result.driver_team || 'Unknown Team',\n        number: result.json_car_number || result.driver_number || result.mapping_driver_number || result.position || 0,\n        \n        // Preserve additional_data (already parsed above)\n        additional_data: additionalData,\n        additionalData: additionalData, // camelCase alias\n        \n        // Race data - store raw time for gap calculation\n        // Convert to numbers and handle null/undefined\n        racePosition: result.position != null ? Number(result.position) : null,\n        _totalRaceTimeMs: result.total_race_time_ms != null ? Number(result.total_race_time_ms) : null, // Store raw value for gap calculation\n        raceLapTime: result.best_lap_time_ms != null ? Number(result.best_lap_time_ms) : null,\n        raceBestLapTime: result.best_lap_time_ms != null ? Number(result.best_lap_time_ms) : null,\n        raceSector1Time: result.sector1_time_ms != null ? Number(result.sector1_time_ms) : null,\n        raceSector2Time: result.sector2_time_ms != null ? Number(result.sector2_time_ms) : null,\n        raceSector3Time: result.sector3_time_ms != null ? Number(result.sector3_time_ms) : null,\n        \n        // Qualifying data (if available from other sessions)\n        qualifyingPosition: result.position != null ? Number(result.position) : null,\n        qualifyingTime: result.best_lap_time_ms != null ? Number(result.best_lap_time_ms) : null,\n        qualifyingBestLapTime: result.best_lap_time_ms != null ? Number(result.best_lap_time_ms) : null,\n        qualifyingSector1Time: result.sector1_time_ms != null ? Number(result.sector1_time_ms) : null,\n        qualifyingSector2Time: result.sector2_time_ms != null ? Number(result.sector2_time_ms) : null,\n        qualifyingSector3Time: result.sector3_time_ms != null ? Number(result.sector3_time_ms) : null,\n        qualifyingTire: visualTireCompound || result.qualifying_tire || result.best_lap_tire || result.tire_compound || null,\n        \n        // Race tire data (all tires used throughout race) - use visual compounds\n        raceTiresUsed: raceTiresUsed || result.race_tires_used || result.tires_used || null,\n        \n        // Points and achievements\n        points: result.points != null ? Number(result.points) : 0,\n        fastestLap: result.fastest_lap === true || result.fastest_lap === 'true' || result.fastest_lap === 1,\n        fastestLapTime: result.best_lap_time_ms != null ? Number(result.best_lap_time_ms) : null,\n        \n        // Status - F1 23 result_status: 0=INVALID, 1=INACTIVE, 2=FINISHED, 3=?, 4=DNF, 5=DSQ, 6=NCL, 7=RET\n        // Based on mapResultStatus: FINISHED=2, DNF=4, DSQ=5, NCL=6, RET=7\n        status: result.result_status === 2 || result.result_status === '2' ? 'finished' : \n                result.result_status === 4 || result.result_status === '4' ? 'dnf' : \n                result.result_status === 5 || result.result_status === '5' ? 'dsq' : \n                result.result_status === 7 || result.result_status === '7' ? 'dnf' : // RET = retired (DNF)\n                result.result_status === 6 || result.result_status === '6' ? 'dnq' : // NCL = not classified\n                'finished', // Default to finished if status is unknown\n        gridPosition: result.grid_position != null ? Number(result.grid_position) : null,\n        \n        // Penalties\n        penalties: result.penalties != null ? Number(result.penalties) : 0, // In-race penalties\n        postRacePenalties: result.post_race_penalties != null ? Number(result.post_race_penalties) : 0, // Post-race penalties\n        totalPenalties: (result.penalties || 0) + (result.post_race_penalties || 0), // Total (in-race + post-race)\n        penaltyReason: result.penalty_reason || result.all_penalty_reasons || null, // Most recent or all reasons\n        warnings: result.warnings != null ? Number(result.warnings) : 0,\n        dnf: result.result_status === 4 || result.result_status === 7 || result.dnf_reason ? true : false,\n        dnfReason: result.dnf_reason,\n        \n        // Lap-by-lap data (if available)\n        lap_times: result.lap_times || [], // Array of { lap_number, lap_time_ms, sector1_ms, sector2_ms, sector3_ms, tire_compound }\n        \n        // Data source\n        dataSource: 'FILE_UPLOAD' as const\n      };\n      \n      return driver;\n    });\n  }, [currentSession]);\n\n  // Memoize gap calculations for race and qualifying\n  const driversWithGaps = useMemo(() => {\n    if (transformedDrivers.length === 0) {\n      return transformedDrivers;\n    }\n\n    const drivers = transformedDrivers.map(driver => ({ ...driver }));\n\n    // Calculate gaps for race (gap to leader)\n    if (activeSession === 'race' && drivers.length > 0) {\n      const leaderTimeMs = (drivers[0] as any)._totalRaceTimeMs || 0;\n      \n      drivers.forEach((driver, index) => {\n        const driverTimeMs = (driver as any)._totalRaceTimeMs || 0;\n        \n        if (index === 0) {\n          // Leader shows their total time\n          driver.raceTime = driverTimeMs > 0 ? F123DataService.formatTimeFromMs(driverTimeMs) : '--:--.---';\n          driver.raceGap = null; // Leader has no gap\n          (driver as any)._raceTimeFormatted = true; // Mark as already formatted\n        } else {\n          // Others show gap to leader (not their total time)\n          if (leaderTimeMs > 0 && driverTimeMs > 0) {\n            const gapMs = driverTimeMs - leaderTimeMs;\n            if (gapMs >= 0) {\n              driver.raceTime = `+${F123DataService.formatGapTimeFromMs(gapMs)}`;\n              driver.raceGap = gapMs;\n          } else {\n              driver.raceTime = '--:--.---';\n              driver.raceGap = null;\n            }\n            (driver as any)._raceTimeFormatted = true; // Mark as already formatted\n          } else {\n            driver.raceTime = '--:--.---';\n            driver.raceGap = null;\n            (driver as any)._raceTimeFormatted = true; // Mark as already formatted\n          }\n        }\n        \n        // Calculate position gain (grid position vs race position)\n        if (driver.gridPosition != null && driver.racePosition != null) {\n          driver.positionGain = driver.gridPosition - driver.racePosition; // Positive = gained positions, negative = lost positions\n        } else {\n          driver.positionGain = null;\n        }\n      });\n    }\n\n    // Calculate gaps for qualifying and practice\n    if ((activeSession === 'qualifying' || activeSession === 'practice') && drivers.length > 0) {\n      const poleTime = drivers[0].qualifyingTime || 0;\n      drivers.forEach(driver => {\n        if (driver.qualifyingTime && driver.qualifyingTime > poleTime) {\n          driver.qualifyingGap = driver.qualifyingTime - poleTime;\n        }\n      });\n    }\n\n    return drivers;\n  }, [transformedDrivers, activeSession]);\n\n  // Memoize updateDriversFromSessions to prevent unnecessary re-renders\n  const updateDriversFromSessions = useCallback(() => {\n    setDrivers(driversWithGaps);\n  }, [driversWithGaps]);\n\n  useEffect(() => {\n    // Update drivers when activeSession changes\n    updateDriversFromSessions();\n  }, [updateDriversFromSessions]);\n\n  useEffect(() => {\n    if (!sessions || sessions.length === 0) {\n      setPenaltiesByDriver({});\n      return;\n    }\n\n    const session = currentSession;\n\n    if (!session || !session.results) {\n      setPenaltiesByDriver({});\n      return;\n    }\n\n    const map: Record<string, DriverPenalty[]> = {};\n    session.results.forEach((result: any) => {\n      const driverSessionResultId = result.id || result.driver_session_result_id;\n      if (!driverSessionResultId) {\n        return;\n      }\n\n      const penalties = result.penalty_details ?? result.penaltyDetails ?? [];\n      const normalizedPenalties = normalizePenalties(penalties, driverSessionResultId);\n\n      if (normalizedPenalties.length > 0) {\n        map[driverSessionResultId] = normalizedPenalties;\n      }\n    });\n\n    setPenaltiesByDriver(map);\n  }, [currentSession, normalizePenalties]);\n\n  const fetchSessionPenalties = useCallback(async () => {\n    if (!sessions || sessions.length === 0) return;\n\n    const session = currentSession;\n\n    const sessionId = session?.id || session?.sessionId;\n    if (!sessionId) return;\n\n    try {\n      const response = await fetch(`${apiUrl}/api/races/sessions/${sessionId}/penalties`);\n\n      if (response.ok) {\n        const data = await response.json();\n        const penalties = Array.isArray(data.penalties) ? data.penalties : [];\n\n        const grouped: Record<string, any[]> = {};\n        penalties.forEach((penalty: any) => {\n          const driverSessionResultId = penalty.driver_session_result_id;\n          if (!driverSessionResultId) {\n            return;\n          }\n\n          if (!grouped[driverSessionResultId]) {\n            grouped[driverSessionResultId] = [];\n          }\n\n          grouped[driverSessionResultId].push(penalty);\n        });\n\n        const map: Record<string, DriverPenalty[]> = {};\n        Object.entries(grouped).forEach(([driverSessionResultId, rawPenalties]) => {\n          const normalized = normalizePenalties(rawPenalties, driverSessionResultId);\n          if (normalized.length > 0) {\n            map[driverSessionResultId] = normalized;\n          }\n        });\n\n        setPenaltiesByDriver(map);\n      }\n    } catch (error) {\n      logger.error('Error fetching session penalties:', error);\n    }\n  }, [currentSession, normalizePenalties, apiUrl]);\n\n  const fetchDriverPenalties = useCallback(async (driverSessionResultId: string) => {\n    if (!driverSessionResultId) return;\n\n    try {\n      const response = await fetch(`${apiUrl}/api/races/driver-results/${driverSessionResultId}/penalties`);\n\n      if (!response.ok) {\n        logger.error('Failed to fetch driver penalties:', response.status, response.statusText);\n        return;\n      }\n\n      const data = await response.json();\n      const penalties = Array.isArray(data.penalties) ? data.penalties : [];\n      const normalized = normalizePenalties(penalties, driverSessionResultId);\n\n      setPenaltiesByDriver(prev => {\n        const updated = { ...prev };\n        if (normalized.length === 0) {\n          delete updated[driverSessionResultId];\n        } else {\n          updated[driverSessionResultId] = normalized;\n        }\n        return updated;\n      });\n    } catch (error) {\n      logger.error('Error fetching driver penalties:', error);\n    }\n  }, [normalizePenalties]);\n\n  // Fetch penalty history when entering edit mode\n  useEffect(() => {\n    if (isEditing && sessions.length > 0) {\n      fetchSessionPenalties();\n      setPendingPenaltyAdds([]);\n      setPendingPenaltyRemovals([]);\n    }\n  }, [isEditing, activeSession, sessions, fetchSessionPenalties]);\n\n  // Note: Removed redundant penalty history fetch when modal opens - already fetched when entering edit mode\n\n  const fetchRaceData = async () => {\n    try {\n      setLoading(true);\n      // Fetch race data\n      const raceResponse = await fetch(`${apiUrl}/api/races/${raceId}`);\n      if (raceResponse.ok) {\n        const raceDataResult = await raceResponse.json();\n        setRaceData(raceDataResult.race);\n      }\n      \n      // Fetch race results\n      const resultsResponse = await fetch(`${apiUrl}/api/races/${raceId}/results`);\n      if (resultsResponse.ok) {\n        const resultsData = await resultsResponse.json();\n        setSessions(resultsData.sessions || []);\n      }\n      \n    } catch (error) {\n      logger.error('Error fetching race data:', error);\n      setError('Failed to load race data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const getTeamColor = (team: string) => F123DataService.getTeamColor(team);\n  const getTeamColorHex = (team: string) => F123DataService.getTeamColorHex(team);\n\n  /**\n   * Determine if a color is light or dark, returns appropriate text color (black or white)\n   */\n  const getContrastTextColor = (hexColor: string): string => {\n    // Remove # if present\n    const hex = hexColor.replace('#', '');\n    \n    // Convert to RGB\n    const r = parseInt(hex.substring(0, 2), 16);\n    const g = parseInt(hex.substring(2, 4), 16);\n    const b = parseInt(hex.substring(4, 6), 16);\n    \n    // Calculate relative luminance (using WCAG formula)\n    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;\n    \n    // Return black for light colors, white for dark colors\n    return luminance > 0.5 ? '#000000' : '#FFFFFF';\n  };\n\n  const getPositionBadgeClass = (position?: number | null) => {\n    if (position === 1) {\n      return 'inline-flex items-center rounded-full bg-amber-500/15 px-3 py-1 text-xs font-semibold text-amber-500 2xl:text-sm';\n    }\n    if (position === 2) {\n      return 'inline-flex items-center rounded-full bg-slate-400/15 px-3 py-1 text-xs font-semibold text-slate-400 2xl:text-sm';\n    }\n    if (position === 3) {\n      return 'inline-flex items-center rounded-full bg-orange-400/15 px-3 py-1 text-xs font-semibold text-orange-400 2xl:text-sm';\n    }\n    return 'inline-flex items-center rounded-full bg-slate-900/10 px-3 py-1 text-xs font-semibold text-slate-600 dark:bg-slate-700/40 dark:text-slate-300 2xl:text-sm';\n  };\n\n  // Get driver_session_result_id - this is the primary identifier for all operations\n  const getDriverSessionResultId = (driver: RaceDriverRow): string | null => {\n    const rawId =\n      (driver as any).driver_session_result_id ??\n      (driver as any).driverSessionResultId ??\n      (driver as any).id ??\n      driver.id ??\n      driver.sessionResultId ??\n      null;\n\n    if (rawId === null || rawId === undefined) {\n      return null;\n    }\n\n    const normalized = String(rawId).trim();\n    return normalized.length > 0 ? normalized : null;\n  };\n\n  const getCanonicalDriverIdentifier = (driver: RaceDriverRow): string | null => {\n    const raw =\n      driver.canonicalDriverId ??\n      driver.mappedUserId ??\n      driver.json_driver_id ??\n      (driver as any)?.jsonDriverId ??\n      (driver as any)?.driver_id ??\n      (driver as any)?.driverId ??\n      (driver.user_id != null ? String(driver.user_id) : null) ??\n      (driver.number != null ? `car-${driver.number}` : null);\n\n    if (raw === null || raw === undefined) {\n      return null;\n    }\n\n    const normalized = String(raw).trim();\n    return normalized.length > 0 ? normalized : null;\n  };\n\n  const sessionResultIdCounts = useMemo(() => {\n    const counts: Record<string, number> = {};\n\n    drivers.forEach((driver) => {\n      const sessionResultId = getDriverSessionResultId(driver);\n      if (!sessionResultId) {\n        return;\n      }\n\n      counts[sessionResultId] = (counts[sessionResultId] ?? 0) + 1;\n    });\n\n    return counts;\n  }, [drivers]);\n\n  const duplicateSessionResultIds = useMemo(() => {\n    const duplicates = new Set<string>();\n\n    Object.entries(sessionResultIdCounts).forEach(([id, count]) => {\n      if (count > 1) {\n        duplicates.add(id);\n      }\n    });\n\n    return duplicates;\n  }, [sessionResultIdCounts]);\n\n  const handleDriverClick = useCallback(\n    (driver: RaceDriverRow) => {\n      const sessionResultId = getDriverSessionResultId(driver);\n\n      // Only use driver_session_result_id - it's unique per driver result\n      if (!sessionResultId) {\n        logger.warn('Cannot navigate: missing driver_session_result_id for driver:', driver.name);\n        return;\n      }\n\n      onDriverSelect(sessionResultId, raceId, activeSession);\n    },\n    [activeSession, onDriverSelect, raceId],\n  );\n\n  const buildDriverRowKey = useCallback(\n    (row: RaceDriverRow, index: number) => {\n      // Prioritize driver_session_result_id first (most unique)\n      const sessionResultId = getDriverSessionResultId(row);\n      if (sessionResultId) {\n        // Even if there are duplicates, include index as a fallback\n        if (duplicateSessionResultIds.has(sessionResultId)) {\n          const canonicalId = getCanonicalDriverIdentifier(row);\n          const fallbackName =\n            row.name && typeof row.name === 'string'\n              ? row.name.replace(/\\s+/g, '-').toLowerCase()\n              : `driver-${index}`;\n          return `${sessionResultId}-${canonicalId ?? fallbackName}-${index}-${activeSession}`;\n        }\n        return `${sessionResultId}-${activeSession}`;\n      }\n\n      // Fallback to other identifiers\n      const uniqueRowId = row.id != null ? String(row.id) : null;\n      const canonicalId = getCanonicalDriverIdentifier(row);\n      const fallbackName =\n        row.name && typeof row.name === 'string'\n          ? row.name.replace(/\\s+/g, '-').toLowerCase()\n          : `driver-${index}`;\n\n      if (uniqueRowId) {\n        return `${uniqueRowId}-${activeSession}`;\n      }\n\n      if (canonicalId) {\n        return `${canonicalId}-${activeSession}`;\n      }\n\n      return `${fallbackName}-${index}-${activeSession}`;\n    },\n    [activeSession, duplicateSessionResultIds],\n  );\n\n  const handleDriverMappingChange = useCallback(\n    async (driver: RaceDriverRow, nextUserId: string | null) => {\n      const driverSessionResultId = getDriverSessionResultId(driver);\n      if (!driverSessionResultId) {\n        return;\n      }\n\n      const normalizedNextUserId = nextUserId ? String(nextUserId) : null;\n      const currentMappedId =\n        driver.mappedUserId ??\n        driver.user_id ??\n        (driver as any)?.mappedUserId ??\n        (driver as any)?.user_id ??\n        null;\n\n      if ((currentMappedId ?? '') === (normalizedNextUserId ?? '')) {\n        return;\n      }\n\n      if (mappingBusy[driverSessionResultId]) {\n        return;\n      }\n\n      setMappingBusy((prev) => ({ ...prev, [driverSessionResultId]: true }));\n      setMappingErrors((prev) => ({ ...prev, [driverSessionResultId]: null }));\n\n      try {\n        const response = await fetch(\n          `${apiUrl}/api/races/driver-results/${driverSessionResultId}/mapping`,\n          {\n            method: 'PUT',\n            headers: {\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\n              userId: normalizedNextUserId,\n              editedBy: 'admin',\n              reason: normalizedNextUserId\n                ? `Mapped to ${\n                    driverOptions.find((option) => option.id === normalizedNextUserId)?.name ??\n                    'league driver'\n                  }`\n                : 'Cleared driver mapping',\n            }),\n          },\n        );\n\n        const data = await response.json();\n        if (response.status === 409) {\n          throw new Error(\n            data.error ||\n              'That league driver is already mapped to another result. Unassign them first.',\n          );\n        }\n        if (!response.ok || !data.success) {\n          throw new Error(data.error || data.details || 'Failed to update driver mapping');\n        }\n\n        const selectedOption = normalizedNextUserId\n          ? driverOptions.find((option) => option.id === normalizedNextUserId) ?? null\n          : null;\n        const nextDisplayName =\n          selectedOption?.name ??\n          driver.mappedUserName ??\n          driver.jsonDriverName ??\n          driver.mappingDriverName ??\n          driver.name;\n\n        setDrivers((prev) =>\n          prev.map((row) => {\n            if (getDriverSessionResultId(row) !== driverSessionResultId) {\n              return row;\n            }\n\n            const updated: RaceDriverRow = {\n              ...row,\n              user_id: normalizedNextUserId,\n              mappedUserId: normalizedNextUserId,\n              mappedUserName: selectedOption?.name ?? null,\n              canonicalDriverId:\n                normalizedNextUserId ??\n                row.json_driver_id ??\n                (row as any)?.jsonDriverId ??\n                row.canonicalDriverId ??\n                null,  // Don't fall back to row.id - keep it null if no better option\n              name: nextDisplayName,\n              // Preserve driver_session_result_id\n              driver_session_result_id: row.driver_session_result_id ?? getDriverSessionResultId(row),\n            };\n            return updated;\n          }),\n        );\n\n        setSessions((prevSessions) =>\n          prevSessions.map((session: any) => {\n            if (!Array.isArray(session?.results)) {\n              return session;\n            }\n\n            const updatedResults = session.results.map((result: any) => {\n              const resultId = result?.id || result?.driver_session_result_id;\n              if (resultId !== driverSessionResultId) {\n                return result;\n              }\n\n              return {\n                ...result,\n                user_id: normalizedNextUserId,\n                driver_name: selectedOption?.name ?? null,\n              };\n            });\n\n            return {\n              ...session,\n              results: updatedResults,\n            };\n          }),\n        );\n\n        setMappingErrors((prev) => {\n          const next = { ...prev };\n          delete next[driverSessionResultId];\n          return next;\n        });\n      } catch (error) {\n        const message =\n          error instanceof Error ? error.message : 'Failed to update driver mapping';\n        setMappingErrors((prev) => ({ ...prev, [driverSessionResultId]: message }));\n      } finally {\n        setMappingBusy((prev) => {\n          const next = { ...prev };\n          delete next[driverSessionResultId];\n          return next;\n        });\n      }\n    },\n    [apiUrl, driverOptions, mappingBusy, setDrivers, setSessions],\n  );\n\n  // Memoize penalty map for O(1) lookups instead of O(n) array iterations\n  const penaltyMap = useMemo(() => {\n    const map = new Map<string, DriverPenalty[]>();\n\n    Object.entries(penaltiesByDriver).forEach(([driverId, penalties]) => {\n      const cloned = penalties.map(penalty => ({\n        ...penalty,\n        isRemovalPending: pendingPenaltyRemovals.some(removal => removal.penaltyId === penalty.id)\n      }));\n      map.set(driverId, cloned);\n    });\n\n    pendingPenaltyAdds.forEach(pending => {\n      const existing = map.get(pending.driverSessionResultId) ?? [];\n      const pendingPenalty: DriverPenalty = {\n        id: pending.id,\n        driverSessionResultId: pending.driverSessionResultId,\n        seconds: pending.seconds,\n        reason: pending.reason,\n        createdAt: new Date().toISOString(),\n        createdBy: 'pending',\n        isPending: true\n      };\n      map.set(pending.driverSessionResultId, [...existing, pendingPenalty]);\n    });\n\n    return map;\n  }, [penaltiesByDriver, pendingPenaltyAdds, pendingPenaltyRemovals]);\n\n  const usedMappedUserIds = useMemo(() => {\n    const ids = new Set<string>();\n    drivers.forEach((driver) => {\n      const mappedId =\n        driver.mappedUserId ??\n        driver.user_id ??\n        (driver as any)?.mappedUserId ??\n        (driver as any)?.user_id ??\n        null;\n      if (mappedId) {\n        ids.add(String(mappedId));\n      }\n    });\n    return ids;\n  }, [drivers]);\n\n  const renderDriverCell = useCallback(\n    (_: unknown, driver: RaceDriverRow) => {\n      const driverSessionResultId = getDriverSessionResultId(driver);\n      const mappedUserId =\n        driver.mappedUserId ??\n        driver.user_id ??\n        (driver as any)?.mappedUserId ??\n        (driver as any)?.user_id ??\n        null;\n      const currentMappedIdValue = mappedUserId ?? '';\n      const isSaving =\n        driverSessionResultId != null && Boolean(mappingBusy[driverSessionResultId]);\n      const errorMessage =\n        driverSessionResultId != null ? mappingErrors[driverSessionResultId] : null;\n\n      const combinedOptions =\n        mappedUserId &&\n        !driverOptions.some((option) => option.id === String(mappedUserId))\n          ? [\n              ...driverOptions,\n              {\n                id: String(mappedUserId),\n                name:\n                  driver.mappedUserName ??\n                  driver.jsonDriverName ??\n                  (driver as any)?.json_driver_name ??\n                  'Mapped Driver',\n                number: null,\n                team: null,\n              },\n            ]\n          : driverOptions;\n\n      return (\n        <div>\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-base font-semibold text-slate-900 dark:text-slate-100\">\n                {driver.name}\n              </span>\n              {isAuthenticated && isEditing && driverSessionResultId && (\n                <select\n                  className=\"rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 transition hover:border-slate-400 focus:border-red-600 focus:outline-none focus:ring-0 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:border-slate-600 dark:focus:border-red-400\"\n                  value={currentMappedIdValue}\n                  disabled={isSaving || driverOptionsLoading}\n                  onChange={(event) => {\n                    handleDriverMappingChange(driver, event.target.value || null);\n                  }}\n                >\n                  <option value=\"\">Unassigned</option>\n                  {combinedOptions.map((option) => {\n                    const optionDisabled =\n                      option.id !== currentMappedIdValue && usedMappedUserIds.has(option.id);\n                    const labelParts = [\n                      option.name,\n                      option.number != null ? `#${option.number}` : null,\n                      option.team ?? null,\n                    ].filter(Boolean);\n                    return (\n                      <option key={option.id} value={option.id} disabled={optionDisabled}>\n                        {labelParts.join(' â€¢ ')}\n                      </option>\n                    );\n                  })}\n                </select>\n              )}\n              {isSaving && (\n                <span className=\"text-[10px] text-slate-400 dark:text-slate-500\">Savingâ€¦</span>\n              )}\n            </div>\n\n            {activeSession === 'race' && driver.positionGain != null && (\n              <div className=\"flex items-center space-x-1\">\n                {driver.positionGain > 0 ? (\n                  <>\n                    <ArrowUp className=\"h-4 w-4 text-green-600 dark:text-green-400\" />\n                    <span className=\"text-sm text-green-600 dark:text-green-400\">\n                      {driver.positionGain}\n                    </span>\n                  </>\n                ) : driver.positionGain < 0 ? (\n                  <>\n                    <ArrowDown className=\"h-4 w-4 text-red-600 dark:text-red-400\" />\n                    <span className=\"text-sm text-red-600 dark:text-red-400\">\n                      {Math.abs(driver.positionGain)}\n                    </span>\n                  </>\n                ) : (\n                  <>\n                    <Minus className=\"h-4 w-4 text-gray-500 dark:text-gray-400\" />\n                    <span className=\"text-sm text-gray-500 dark:text-gray-400\">0</span>\n                  </>\n                )}\n              </div>\n            )}\n          </div>\n          {errorMessage && isAuthenticated && isEditing && (\n            <div className=\"mt-1 text-xs text-red-500 dark:text-red-400\">{errorMessage}</div>\n          )}\n        </div>\n      );\n    },\n    [\n      activeSession,\n      driverOptions,\n      driverOptionsLoading,\n      handleDriverMappingChange,\n      isAuthenticated,\n      isEditing,\n      mappingBusy,\n      mappingErrors,\n      usedMappedUserIds,\n    ],\n  );\n\n  useEffect(() => {\n    if (!isEditing) {\n      setMappingErrors({});\n      setMappingBusy({});\n    }\n  }, [isEditing]);\n\n\n  // Memoize fastest sectors calculation (use reduce to avoid stack overflow with large arrays)\n  // MUST be before any early returns to follow Rules of Hooks\n  const fastestSectors = useMemo(() => ({\n    s1: drivers.reduce((min, d) => {\n      const time = d.qualifyingSector1Time;\n      return time && time < min ? time : min;\n    }, Infinity),\n    s2: drivers.reduce((min, d) => {\n      const time = d.qualifyingSector2Time;\n      return time && time < min ? time : min;\n    }, Infinity),\n    s3: drivers.reduce((min, d) => {\n      const time = d.qualifyingSector3Time;\n      return time && time < min ? time : min;\n    }, Infinity)\n  }), [drivers]);\n  \n  const fastestS1 = fastestSectors.s1;\n  const fastestS2 = fastestSectors.s2;\n  const fastestS3 = fastestSectors.s3;\n\n  // Helper function to check if a driver has existing penalties\n  // Uses driver_session_result_id (UUID) for direct matching\n  const driverHasExistingPenalties = useCallback((driver: RaceDriverRow): boolean => {\n    const driverSessionResultId = getDriverSessionResultId(driver);\n    \n    // Silently return false if we can't identify the driver\n    if (!driverSessionResultId) return false;\n    \n    // First check: Does the driver have post-race penalties in their data?\n    const postRacePenalties = (driver as any).postRacePenalties || 0;\n    if (postRacePenalties > 0) {\n      return true;\n    }\n    \n    // Second check: Use Map for O(1) lookup\n    const penalties = penaltyMap.get(driverSessionResultId) || [];\n    if (penalties.some(p => !p.isRemovalPending)) {\n      return true;\n    }\n    \n    // Third check: Pending additions\n    const matchingPendingAdd = pendingPenaltyAdds.some(p => p.driverSessionResultId === driverSessionResultId);\n    \n    return matchingPendingAdd;\n  }, [penaltyMap, pendingPenaltyAdds]);\n\n  const formatRaceTotalTime = (driver: RaceDriverRow) => {\n    if ((driver as any)._raceTimeFormatted && driver.raceTime) {\n      return (driver as any).raceTime;\n    }\n\n    const totalTimeMs = (driver as any)._totalRaceTimeMs;\n    if (totalTimeMs && totalTimeMs > 0) {\n      return F123DataService.formatTimeFromMs(totalTimeMs);\n    }\n\n    return '--:--.---';\n  };\n\n  const renderPenaltyCell = (driver: RaceDriverRow) => {\n    if (isEditing) {\n      const hasExistingPenalties = driverHasExistingPenalties(driver);\n      const buttonColor = hasExistingPenalties\n        ? 'text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40 hover:text-red-700 dark:hover:text-red-300 border-red-300 dark:border-red-700 hover:border-red-500 dark:hover:border-red-500'\n        : 'text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/40 hover:text-blue-700 dark:hover:text-blue-300 border-blue-300 dark:border-blue-700 hover:border-blue-500 dark:hover:border-blue-500';\n\n      return (\n        <div className=\"flex items-center justify-center\">\n          <button\n            onClick={async (e) => {\n              e.stopPropagation();\n              logger.debug('ðŸ” CLICKED ADD BUTTON - Driver object:', {\n                driver,\n                driver_keys: Object.keys(driver as any),\n                has_additional_data: !!(driver as any).additional_data,\n                has_additionalData: !!(driver as any).additionalData,\n                additional_data_sample: (driver as any).additional_data ? JSON.stringify((driver as any).additional_data).substring(0, 200) : 'MISSING',\n                additionalData_sample: (driver as any).additionalData ? JSON.stringify((driver as any).additionalData).substring(0, 200) : 'MISSING'\n              });\n              setSelectedDriver(driver);\n              setPenaltySeconds('5');\n              setPenaltyReason('');\n              setPendingPenaltyAdds([]);\n              setPendingPenaltyRemovals([]);\n              setPenaltyModalOpen(true);\n              const driverSessionResultId = getDriverSessionResultId(driver);\n              if (driverSessionResultId) {\n                await fetchDriverPenalties(driverSessionResultId);\n              } else {\n                await fetchSessionPenalties();\n              }\n            }}\n            className={`px-3 py-1.5 rounded-lg text-sm font-medium border transition-all duration-200 ${buttonColor}`}\n          >\n            Add\n          </button>\n        </div>\n      );\n    }\n\n    const totalPenalties = (driver as any).totalPenalties;\n    if (totalPenalties != null && totalPenalties > 0) {\n      const penaltyReason = (driver as any).penaltyReason;\n      return (\n        <div\n          className=\"relative inline-block group\"\n          onMouseEnter={(e) => {\n            const tooltip = e.currentTarget.querySelector('.penalty-tooltip') as HTMLElement;\n            if (tooltip) {\n              tooltip.style.opacity = '1';\n              tooltip.style.visibility = 'visible';\n            }\n          }}\n          onMouseLeave={(e) => {\n            const tooltip = e.currentTarget.querySelector('.penalty-tooltip') as HTMLElement;\n            if (tooltip) {\n              tooltip.style.opacity = '0';\n              tooltip.style.visibility = 'hidden';\n            }\n          }}\n        >\n          <span className=\"text-base font-normal text-red-600 dark:text-red-400 cursor-help underline decoration-dotted\">\n            {totalPenalties}s\n          </span>\n          {penaltyReason && (\n            <div className=\"penalty-tooltip absolute bottom-full left-1/2 z-50 -translate-x-1/2 transform whitespace-nowrap rounded bg-gray-900 px-2 py-1 text-xs text-white opacity-0 shadow-lg transition-all duration-200 dark:bg-gray-700\">\n              {penaltyReason}\n              <div className=\"absolute top-full left-1/2 -mt-1 -translate-x-1/2 transform border-4 border-transparent border-t-gray-900 dark:border-t-gray-700\" />\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    return <span className=\"text-base text-gray-500 dark:text-gray-400\">-</span>;\n  };\n\n  const renderRaceTiresCell = (driver: RaceDriverRow) => {\n    const tiresUsed = (driver as any).raceTiresUsed;\n    if (!tiresUsed || (Array.isArray(tiresUsed) && tiresUsed.length === 0)) {\n      return <span className=\"text-lg text-gray-500 dark:text-gray-400\">-</span>;\n    }\n\n    if (Array.isArray(tiresUsed)) {\n      const tireStrings = tiresUsed.map((t: any) => {\n        if (typeof t === 'number') {\n          return getTireCompound(t);\n        }\n        const tireStr = String(t).toLowerCase();\n        if (tireStr.includes('soft')) return 'S';\n        if (tireStr.includes('medium')) return 'M';\n        if (tireStr.includes('hard')) return 'H';\n        if (tireStr.includes('intermediate')) return 'I';\n        if (tireStr.includes('wet')) return 'W';\n        return String(t);\n      });\n\n      return (\n        <div className=\"flex items-center justify-center gap-1\">\n          {tireStrings.map((tireStr, idx) => {\n            const icon = F123DataService.getTireCompoundIcon(tireStr);\n            const fullName = F123DataService.getTireCompoundFullName(tireStr);\n            const label = F123DataService.getTireCompoundText(tireStr);\n            return icon ? (\n              <img\n                key={`${tireStr}-${idx}`}\n                src={icon}\n                alt={`${fullName} tire`}\n                className=\"h-6 w-6\"\n              />\n            ) : (\n              <span key={`${tireStr}-${idx}`} className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n                {label}\n              </span>\n            );\n          })}\n        </div>\n      );\n    }\n\n    const icon = F123DataService.getTireCompoundIcon(tiresUsed);\n    const fullName = F123DataService.getTireCompoundFullName(tiresUsed);\n    const label = F123DataService.getTireCompoundText(tiresUsed);\n    return icon ? (\n      <div className=\"flex items-center justify-center\">\n        <img src={icon} alt={`${fullName} tire`} className=\"h-6 w-6\" />\n      </div>\n    ) : (\n      <span className=\"text-lg text-gray-900 dark:text-white\">{label}</span>\n    );\n  };\n\n  const renderQualifyingTireCell = (driver: RaceDriverRow) => {\n    const tire = (driver as any).qualifyingTire;\n    if (!tire) {\n      return <span className=\"text-lg text-gray-500 dark:text-gray-400\">-</span>;\n    }\n\n    const tireValue = typeof tire === 'number' ? getTireCompound(tire) : tire;\n    const icon = F123DataService.getTireCompoundIcon(tireValue);\n    const label = F123DataService.getTireCompoundText(tireValue);\n    const fullName = F123DataService.getTireCompoundFullName(tireValue);\n\n    if (icon) {\n      return (\n        <div className=\"flex items-center justify-center\">\n          <img src={icon} alt={`${fullName} tire`} className=\"h-6 w-6\" />\n        </div>\n      );\n    }\n\n    return (\n      <span className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n        {label}\n      </span>\n    );\n  };\n\n  // Helper function to get all penalties for a driver (for modal display)\n  // Uses driver_session_result_id (UUID) for direct matching with Map lookup\n  const getDriverPenalties = useCallback((driver: RaceDriverRow): DriverPenalty[] => {\n    const driverSessionResultId = getDriverSessionResultId(driver);\n    \n    if (!driverSessionResultId) return [];\n    \n    // Use Map for O(1) lookup instead of filtering array\n    const matchingPenalties = penaltyMap.get(driverSessionResultId) || [];\n    \n    return [...matchingPenalties].sort((a, b) => {\n      const aDate = new Date(a.createdAt).getTime();\n      const bDate = new Date(b.createdAt).getTime();\n      return bDate - aDate;\n    });\n  }, [penaltyMap]);\n\n  const getCurrentSession = () => {\n    const session = currentSession;\n    return session?.sessionId || session?.id;\n  };\n\n  const handleAddPenaltyToPending = () => {\n    if (!selectedDriver) {\n      alert('No driver selected');\n      return;\n    }\n\n    if (!penaltySeconds || !penaltyReason.trim()) {\n      alert('Please enter penalty seconds and reason');\n      return;\n    }\n\n    const seconds = parseFloat(penaltySeconds);\n    if (isNaN(seconds) || seconds <= 0) {\n      alert('Penalty seconds must be a positive number');\n      return;\n    }\n\n    // Add to pending list - use driver_session_result_id (UUID)\n    const driverSessionResultId = getDriverSessionResultId(selectedDriver);\n    \n    if (!driverSessionResultId) {\n      alert(`Unable to identify driver. Missing driver_session_result_id.`);\n      return;\n    }\n    \n    const newPenalty: PendingPenaltyAdd = {\n      seconds,\n      reason: penaltyReason.trim(),\n      id: `pending-${Date.now()}-${Math.random()}`,\n      driverSessionResultId: driverSessionResultId  // UUID from driver_session_results.id\n    };\n    \n    setPendingPenaltyAdds([...pendingPenaltyAdds, newPenalty]);\n    setPenaltySeconds('5');\n    setPenaltyReason('');\n  };\n\n  const handleRemovePendingPenalty = (id: string) => {\n    setPendingPenaltyAdds(pendingPenaltyAdds.filter(p => p.id !== id));\n  };\n\n  const handleApplyPenalties = () => {\n    // This function now just closes the modal and keeps changes pending\n    // Changes are only saved when main \"Save\" button is clicked\n    // This allows Cancel to properly discard all changes\n    setPenaltyModalOpen(false);\n    setSelectedDriver(null);\n    setPenaltySeconds('5');\n    setPenaltyReason('');\n    // Note: pendingPenaltyAdds and pendingPenaltyRemovals are NOT cleared here\n    // They remain pending until Save or Cancel is clicked in edit mode\n  };\n\n  const handleSaveAllChanges = async () => {\n    try {\n      // Apply all pending penalty additions (use driverSessionResultId)\n      for (const penalty of pendingPenaltyAdds) {\n        if (!penalty.driverSessionResultId) {\n          logger.warn('Skipping penalty with missing driverSessionResultId:', penalty);\n          continue;\n        }\n        \n        const response = await fetch(`${apiUrl}/api/races/driver-results/${penalty.driverSessionResultId}/penalties`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            penaltySeconds: penalty.seconds,\n            reason: penalty.reason,\n            editedBy: 'admin'\n          })\n        });\n\n        const data = await response.json();\n        if (!response.ok || !data.success) {\n          throw new Error(data.error || data.details || 'Failed to add penalty');\n        }\n      }\n\n      // Apply all pending penalty removals\n      for (const removal of pendingPenaltyRemovals) {\n        if (!removal.penaltyId) {\n          logger.warn('Skipping removal with missing penaltyId:', removal);\n          continue;\n        }\n\n        if (!removal.driverSessionResultId) {\n          logger.warn('Skipping removal with missing driverSessionResultId:', removal);\n          continue;\n        }\n\n        logger.debug(`Removing penalty: ${removal.penaltyId}, driverSessionResultId: ${removal.driverSessionResultId}`);\n\n        const response = await fetch(`${apiUrl}/api/races/driver-results/${removal.driverSessionResultId}/penalties/${removal.penaltyId}`, {\n          method: 'DELETE'\n        });\n\n        const data = await response.json();\n        if (!response.ok || !data.success) {\n          throw new Error(data.error || data.details || 'Failed to remove penalty');\n        }\n      }\n\n      // Refresh all data\n      await fetchSessionPenalties();\n      await fetchRaceData();\n      setIsEditing(false);\n      setPendingPenaltyAdds([]);\n      setPendingPenaltyRemovals([]);\n    } catch (error) {\n      logger.error('Error saving changes:', error);\n      alert(`Failed to save changes: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  };\n\n  const handleCancelEdit = async () => {\n    // Discard ALL pending changes and reload original state\n    // This ensures no changes are saved when Cancel is clicked\n    logger.debug('Canceling edit mode - discarding all pending changes:', {\n      pendingPenaltyAdds: pendingPenaltyAdds.length,\n      pendingPenaltyRemovals: pendingPenaltyRemovals.length\n    });\n    \n    setPendingPenaltyAdds([]);\n    setPendingPenaltyRemovals([]);\n    setPenaltyModalOpen(false);\n    setSelectedDriver(null);\n    setPenaltySeconds('5');\n    setPenaltyReason('');\n    setIsEditing(false);\n    \n    // Reload data to get original state (this will overwrite any local changes)\n    await fetchRaceData();\n    await fetchSessionPenalties();\n    \n    logger.debug('Edit mode cancelled - all pending changes discarded');\n  };\n\n  const handleRemovePenaltyById = (driver: RaceDriverRow, penalty: DriverPenalty) => {\n    // Add to pending removals instead of applying immediately\n    // Use driver_session_result_id (UUID) for matching\n    const driverSessionResultId = getDriverSessionResultId(driver);\n    \n    if (!driverSessionResultId) {\n      logger.warn('Cannot remove penalty - missing driverSessionResultId');\n      return;\n    }\n\n    if (penalty.isPending) {\n      setPendingPenaltyAdds(pendingPenaltyAdds.filter(p => p.id !== penalty.id));\n      return;\n    }\n    \n    // Check if already in pending removals\n    const alreadyPending = pendingPenaltyRemovals.some(r => r.penaltyId === penalty.id);\n    if (alreadyPending) {\n      // Remove from pending if already there (toggle)\n      setPendingPenaltyRemovals(pendingPenaltyRemovals.filter(r => r.penaltyId !== penalty.id));\n      return;\n    }\n    \n    setPendingPenaltyRemovals([...pendingPenaltyRemovals, {\n      penaltyId: penalty.id,\n      driverSessionResultId: driverSessionResultId\n    }]);\n    \n    logger.debug('Added penalty to pending removals:', {\n      penaltyId: penalty.id,\n      driverSessionResultId: driverSessionResultId,\n      totalPending: pendingPenaltyRemovals.length + 1\n    });\n  };\n\n  const distanceLabel = raceData?.track?.length ? `${raceData.track.length} km` : 'Distance TBD';\n  const lapsLabel = raceData?.laps != null ? `${raceData.laps} laps` : 'Laps TBD';\n  const heroTitle = raceData?.trackName ?? 'Race Overview';\n  const heroSubtitle = 'Race Results';\n  const heroDescription = raceData?.raceDate\n    ? `${new Date(raceData.raceDate).toLocaleDateString()} â€¢ ${distanceLabel} â€¢ ${lapsLabel}`\n    : `${distanceLabel} â€¢ ${lapsLabel}`;\n  const heroBase = {\n    imageSrc: '/raw/images/SI202510260512-Aangepast.jpg',\n    title: heroTitle,\n    subtitle: heroSubtitle,\n    description: heroDescription,\n  };\n  const isReady = !loading && !error && !!raceData;\n  const distanceDisplay = raceData?.track?.length ? `${raceData.track.length} km` : distanceLabel;\n  const lapsDisplay = raceData?.laps != null ? `${raceData.laps} laps` : lapsLabel;\n  const raceMetaParts = [distanceDisplay, lapsDisplay].filter(Boolean);\n\n  const viewState = loading\n    ? 'loading'\n    : error\n      ? 'error'\n      : !raceData\n        ? 'empty'\n        : 'ready';\n\n  const heroStatus = (() => {\n    switch (viewState) {\n      case 'loading':\n    return (\n          <div className=\"rounded-full border border-white/25 px-5 py-2 text-xs font-semibold uppercase tracking-[0.4em] text-white/70 backdrop-blur\">\n            Loading Race Data\n      </div>\n    );\n      case 'error':\n    return (\n          <div className=\"rounded-full border border-red-400/60 px-5 py-2 text-xs font-semibold uppercase tracking-[0.4em] text-red-200 backdrop-blur\">\n            Error Loading Race\n      </div>\n    );\n      case 'empty':\n    return (\n          <div className=\"rounded-full border border-white/20 px-5 py-2 text-xs font-semibold uppercase tracking-[0.4em] text-white/70 backdrop-blur\">\n            Awaiting Selection\n      </div>\n    );\n      default:\n        return undefined;\n    }\n  })();\n\n  const isQualifyingSession = activeSession === 'qualifying' || activeSession === 'practice';\n\n  const baseHeaderPadding = 'px-3 py-3 2xl:px-4 2xl:py-3';\n  const baseCellPadding = 'px-3 py-3 2xl:px-4 2xl:py-3';\n\n  const tableColumns: DashboardTableColumn<RaceDriverRow>[] = [\n    {\n      key: 'position',\n      label: 'Pos',\n      align: 'center',\n      headerClassName: clsx(baseHeaderPadding, 'w-16'),\n      className: clsx(baseCellPadding, 'w-16'),\n      render: (_: unknown, row) => {\n        const positionValue = isQualifyingSession\n          ? row.qualifyingPosition ?? (row as any).position ?? null\n          : row.racePosition ?? (row as any).position ?? null;\n\n    return (\n          <div className=\"flex justify-center\">\n            <span className={getPositionBadgeClass(positionValue)}>\n              P{positionValue ?? 'â€”'}\n            </span>\n      </div>\n        );\n      },\n    },\n    {\n      key: 'driver',\n      label: 'Driver',\n      align: 'left' as const,\n      headerClassName: clsx(baseHeaderPadding, 'text-left'),\n    className: clsx(baseCellPadding, 'w-56'),\n      render: renderDriverCell,\n    },\n    {\n      key: 'team',\n      label: 'Team',\n      align: 'left' as const,\n      headerClassName: clsx(baseHeaderPadding, 'text-left'),\n      className: clsx(baseCellPadding, 'w-40'),\n      render: (_: unknown, row) => {\n        const teamColor = getTeamColorHex(row.team);\n        return (\n          <span\n            className=\"text-base font-medium\"\n            style={{ color: teamColor }}\n          >\n            {row.team}\n          </span>\n        );\n      },\n    },\n  ];\n\n  if (activeSession === 'race') {\n    tableColumns.push(\n      {\n        key: 'grid',\n        label: 'Grid',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-16'),\n        className: clsx(baseCellPadding, 'w-16 text-lg text-gray-900 dark:text-white'),\n        render: (_: unknown, row) => (row.gridPosition != null ? row.gridPosition : 'â€”'),\n      },\n      {\n        key: 'bestLap',\n        label: 'Best Lap',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-28'),\n        className: clsx(baseCellPadding, 'w-28'),\n        render: (_: unknown, row) => (\n          <span\n            className={`text-lg ${\n              row.fastestLap\n                ? 'text-purple-600 dark:text-purple-400 font-semibold'\n                : 'text-gray-900 dark:text-white'\n            }`}\n          >\n            {row.raceBestLapTime ? F123DataService.formatTimeFromMs(row.raceBestLapTime) : '--:--.---'}\n          </span>\n        ),\n      },\n      {\n        key: 'totalTime',\n        label: 'Total Time',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-28'),\n        className: clsx(baseCellPadding, 'w-28 text-lg text-gray-900 dark:text-white'),\n        render: (_: unknown, row) => formatRaceTotalTime(row),\n      },\n      {\n        key: 'penalty',\n        label: 'Penalty',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-20'),\n        className: clsx(baseCellPadding, 'w-20'),\n        render: (_: unknown, row) => renderPenaltyCell(row),\n      },\n      {\n        key: 'status',\n        label: 'Status',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-24'),\n        className: clsx(baseCellPadding, 'w-24'),\n        render: (_: unknown, row) => (\n          <span\n            className={`inline-block rounded-full px-2 py-1 text-sm font-medium ${\n              row.status === 'finished'\n                ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'\n                : row.status === 'dnf'\n                  ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'\n                  : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'\n            }`}\n          >\n            {row.status}\n          </span>\n        ),\n      },\n      {\n        key: 'tires',\n        label: 'Tires',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-24'),\n        className: clsx(baseCellPadding, 'w-24'),\n        render: (_: unknown, row) => renderRaceTiresCell(row),\n      },\n      {\n        key: 'points',\n        label: 'Points',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-16'),\n        className: clsx(baseCellPadding, 'w-16 text-lg text-gray-900 dark:text-white'),\n        render: (_: unknown, row) => (row.points != null ? row.points : 'â€”'),\n      }\n    );\n  } else {\n    tableColumns.push(\n      {\n        key: 'time',\n        label: 'Time',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-28'),\n        className: clsx(baseCellPadding, 'w-28 text-lg text-gray-900 dark:text-white'),\n        render: (_: unknown, row) =>\n          row.qualifyingTime ? F123DataService.formatTimeFromMs(row.qualifyingTime) : '--:--.---',\n      },\n      {\n        key: 'gap',\n        label: 'Gap',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-24'),\n        className: clsx(baseCellPadding, 'w-24 text-lg text-gray-900 dark:text-white'),\n        render: (_: unknown, row) => {\n          if (row.qualifyingGap && row.qualifyingGap > 0) {\n            return '+' + F123DataService.formatGapTimeFromMs(row.qualifyingGap);\n          }\n          if (row.qualifyingPosition === 1) {\n            return activeSession === 'qualifying' ? 'Pole' : 'Leader';\n          }\n          return '--.---';\n        },\n      },\n      {\n        key: 's1',\n        label: 'S1',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-20'),\n        className: clsx(baseCellPadding, 'w-20 text-lg font-medium'),\n        render: (_: unknown, row) => {\n          const value = row.qualifyingSector1Time;\n          const isFastest = value != null && value === fastestS1 && fastestS1 !== Infinity;\n          return (\n            <span className={isFastest ? 'text-purple-600 dark:text-purple-400' : 'text-gray-900 dark:text-white'}>\n              {value ? F123DataService.formatSectorTimeFromMs(value) : '--.---'}\n            </span>\n          );\n        },\n      },\n      {\n        key: 's2',\n        label: 'S2',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-20'),\n        className: clsx(baseCellPadding, 'w-20 text-lg font-medium'),\n        render: (_: unknown, row) => {\n          const value = row.qualifyingSector2Time;\n          const isFastest = value != null && value === fastestS2 && fastestS2 !== Infinity;\n          return (\n            <span className={isFastest ? 'text-purple-600 dark:text-purple-400' : 'text-gray-900 dark:text-white'}>\n              {value ? F123DataService.formatSectorTimeFromMs(value) : '--.---'}\n            </span>\n          );\n        },\n      },\n      {\n        key: 's3',\n        label: 'S3',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-20'),\n        className: clsx(baseCellPadding, 'w-20 text-lg font-medium'),\n        render: (_: unknown, row) => {\n          const value = row.qualifyingSector3Time;\n          const isFastest = value != null && value === fastestS3 && fastestS3 !== Infinity;\n          return (\n            <span className={isFastest ? 'text-purple-600 dark:text-purple-400' : 'text-gray-900 dark:text-white'}>\n              {value ? F123DataService.formatSectorTimeFromMs(value) : '--.---'}\n            </span>\n          );\n        },\n      },\n      {\n        key: 'tire',\n        label: 'Tire',\n        align: 'center',\n        headerClassName: clsx(baseHeaderPadding, 'w-16'),\n        className: clsx(baseCellPadding, 'w-16'),\n        render: (_: unknown, row) => renderQualifyingTireCell(row),\n      }\n    );\n  }\n\n  const tableEmptyMessage =\n    activeSession === 'qualifying'\n      ? 'No qualifying results available.'\n      : activeSession === 'practice'\n        ? 'No practice results available.'\n        : 'No race results available.';\n\n  return (\n    <DashboardPage\n      hero={{ ...heroBase, content: heroStatus }}\n      isReady={viewState !== 'loading'}\n      contentClassName=\"space-y-6\"\n    >\n      {viewState === 'error' && (\n        <div className=\"rounded-3xl border border-red-500/30 bg-red-500/10 p-10 text-center text-sm text-red-200 backdrop-blur dark:border-red-400/40 dark:bg-red-500/15\">\n          <p className=\"text-base font-semibold uppercase tracking-[0.3em]\">Unable to load</p>\n          <p className=\"mt-2 text-sm text-red-200/80\">{error}</p>\n      </div>\n      )}\n\n      {viewState === 'empty' && (\n        <div className=\"rounded-3xl border border-dashed border-white/20 bg-white/10 p-12 text-center text-sm text-white/70 backdrop-blur dark:border-white/15 dark:bg-slate-900/50\">\n          <p className=\"text-base font-semibold uppercase tracking-[0.3em] text-white/80\">No race selected</p>\n          <p className=\"mt-2 text-sm text-white/65\">Choose a race to review classification, stints, and telemetry.</p>\n              </div>\n              )}\n\n      {viewState === 'ready' && (\n        <div className=\"space-y-6\">\n      {/* Session Toggle */}\n      {(sessionTypes.hasRace || sessionTypes.hasQualifying || sessionTypes.hasPractice) && (\n      <div className=\"flex flex-col gap-4 md:flex-row md:items-center md:justify-between\">\n      <div className=\"flex h-10 items-center rounded-xl bg-slate-100 p-1 text-sm font-medium dark:bg-slate-900\">\n              {sessionTypes.hasRace && (\n          <button\n            onClick={() => handleSessionChange('race')}\n            className={`rounded-lg px-3 py-1 transition-colors ${\n              activeSession === 'race'\n                    ? 'bg-red-600 text-white shadow-lg shadow-red-600/30'\n                    : 'text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-100'\n            }`}\n          >\n            Race\n          </button>\n              )}\n              {sessionTypes.hasQualifying && (\n          <button\n            onClick={() => handleSessionChange('qualifying')}\n            className={`rounded-lg px-3 py-1 transition-colors ${\n              activeSession === 'qualifying'\n                    ? 'bg-red-600 text-white shadow-lg shadow-red-600/30'\n                    : 'text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-100'\n            }`}\n          >\n            Qualifying\n          </button>\n              )}\n              {sessionTypes.hasPractice && (\n          <button\n            onClick={() => handleSessionChange('practice')}\n            className={`rounded-lg px-3 py-1 transition-colors ${\n              activeSession === 'practice'\n                    ? 'bg-red-600 text-white shadow-lg shadow-red-600/30'\n                    : 'text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-100'\n            }`}\n          >\n            Practice\n          </button>\n              )}\n        </div>\n            {isAuthenticated && (\n              <>\n                {isEditing ? (\n                <div className=\"flex items-center gap-2\">\n                    <button\n                      onClick={handleCancelEdit}\n                    className=\"rounded-lg border border-slate-300 px-3 py-1.5 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-200 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800\"\n                    >\n                      Cancel\n                    </button>\n                    <button\n                      onClick={handleSaveAllChanges}\n                    className=\"rounded-lg bg-emerald-500 px-3 py-1.5 text-sm font-semibold text-white transition-colors hover:bg-emerald-400\"\n                    >\n                      Save\n                    </button>\n      </div>\n                ) : (\n                  <button\n                    onClick={() => setIsEditing(true)}\n                  className=\"flex items-center gap-2 rounded-lg border border-slate-300 px-3 py-1.5 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-200 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800\"\n                  >\n                    <Edit className=\"w-4 h-4\" />\n                    <span>Edit</span>\n                  </button>\n                )}\n              </>\n            )}\n        </div>\n      )}\n\n      {/* Results Table */}\n        <DashboardTable\n          columns={tableColumns}\n          rows={drivers}\n          rowKey={(row, index) => buildDriverRowKey(row, index)}\n          onRowClick={!isEditing ? (row) => handleDriverClick(row) : undefined}\n          emptyMessage={tableEmptyMessage}\n        />\n                                </div>\n                              )}\n\n      {/* Penalty Modal */}\n      {penaltyModalOpen && selectedDriver && (\n        <div \n          className=\"modal-overlay\"\n          onClick={(e) => {\n            // Close modal if clicking the backdrop\n            // Don't clear pending changes - user might want to continue editing\n            if (e.target === e.currentTarget) {\n              setPenaltyModalOpen(false);\n              setSelectedDriver(null);\n              setPenaltySeconds('5');\n              setPenaltyReason('');\n              // Note: pendingPenaltyAdds and pendingPenaltyRemovals are NOT cleared\n              // They remain pending until Save or Cancel is clicked in edit mode\n            }\n          }}\n        >\n          <div \n            className=\"modal-panel max-w-md p-6 mx-4\"\n            onClick={(e) => e.stopPropagation()} // Prevent backdrop click from closing\n          >\n            <h2 className=\"text-xl font-bold text-gray-900 dark:text-white mb-4\">\n              Manage Penalty - {selectedDriver.name}\n            </h2>\n            \n            {/* Existing Penalties List */}\n            {(() => {\n              const driverSessionResultId = getDriverSessionResultId(selectedDriver);\n              const penalties = getDriverPenalties(selectedDriver);\n              const committedPenalties = penalties.filter((penalty: DriverPenalty) => !penalty.isPending);\n              const pendingAddsForDriver = pendingPenaltyAdds.filter(p => p.driverSessionResultId === driverSessionResultId);\n              \n              return (\n                <>\n                  <div className=\"mb-4\">\n                    <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                      Active Penalties\n                    </label>\n                    {committedPenalties.length > 0 ? (\n                      <div className=\"space-y-2 max-h-40 overflow-y-auto\">\n                        {committedPenalties.map((penalty) => (\n                          <div\n                            key={penalty.id}\n                            className=\"flex items-center justify-between bg-red-50 dark:bg-red-900/20 px-3 py-2 rounded border border-red-200 dark:border-red-800\"\n                          >\n                            <div className=\"flex flex-col\">\n                              <span className=\"text-sm font-medium text-red-700 dark:text-red-300\">\n                                {penalty.seconds > 0 ? `+${penalty.seconds}s` : `${penalty.seconds}s`}\n                                <span className=\"font-normal\">\n                                  {penalty.reason ? ` â€“ ${penalty.reason}` : ' â€“ No reason provided'}\n                                </span>\n                              </span>\n                              <span className=\"text-xs text-gray-500 dark:text-gray-400\">\n                                Added {new Date(penalty.createdAt).toLocaleString()} {penalty.createdBy ? `by ${penalty.createdBy}` : ''}\n                              </span>\n                              {penalty.isRemovalPending && (\n                                <span className=\"mt-1 inline-flex items-center w-fit rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-semibold text-yellow-800\">\n                                  Removal pending\n                                </span>\n                              )}\n                            </div>\n                            <button\n                              onClick={() => {\n                                handleRemovePenaltyById(selectedDriver, penalty);\n                              }}\n                              className={`text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200 hover:bg-red-100 dark:hover:bg-red-900/40 rounded p-1 transition-colors ${penalty.isRemovalPending ? 'opacity-60' : ''}`}\n                              title={penalty.isRemovalPending ? 'Undo removal' : 'Mark for removal'}\n                            >\n                              <X size={16} />\n                            </button>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <p className=\"text-sm text-gray-500 dark:text-gray-400\">No existing post-race penalties</p>\n                    )}\n                  </div>\n\n                  {pendingAddsForDriver.length > 0 && (\n                    <div className=\"mb-4\">\n                      <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                        Pending Additions\n                      </label>\n                      <div className=\"space-y-2 max-h-40 overflow-y-auto\">\n                        {pendingAddsForDriver.map((penalty) => (\n                          <div key={penalty.id} className=\"flex items-center justify-between bg-blue-50 dark:bg-blue-900/20 px-3 py-2 rounded border border-blue-200 dark:border-blue-800\">\n                            <span className=\"text-sm text-blue-700 dark:text-blue-300 font-medium\">\n                              +{penalty.seconds}s â€“ {penalty.reason}\n                            </span>\n                            <button\n                              onClick={() => handleRemovePendingPenalty(penalty.id)}\n                              className=\"text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 hover:bg-blue-100 dark:hover:bg-blue-900/40 rounded p-1 transition-colors\"\n                              title=\"Remove from pending\"\n                            >\n                              <X size={16} />\n                            </button>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n                </>\n              );\n            })()}\n            \n            {/* Add New Penalty Form */}\n            <div className=\"space-y-4 mb-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                  Penalty Seconds\n                </label>\n                <input\n                  type=\"number\"\n                  min=\"0.1\"\n                  step=\"0.1\"\n                  value={penaltySeconds}\n                  onChange={(e) => setPenaltySeconds(e.target.value)}\n                  className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  placeholder=\"5\"\n                />\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                  Reason\n                </label>\n                <textarea\n                  value={penaltyReason}\n                  onChange={(e) => setPenaltyReason(e.target.value)}\n                  className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  rows={2}\n                  placeholder=\"Enter reason for penalty (e.g., Track limits violation)\"\n                  autoComplete=\"off\"\n                  data-autocomplete=\"off\"\n                  spellCheck={false}\n                />\n              </div>\n              \n              <button\n                onClick={handleAddPenaltyToPending}\n                className=\"w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors\"\n              >\n                Add to List\n              </button>\n            </div>\n            \n            {/* Action Buttons */}\n            <div className=\"flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700\">\n              <button\n                onClick={() => {\n                  // Discard pending changes for this driver only\n                  const driverSessionResultId = getDriverSessionResultId(selectedDriver);\n                  \n                  if (driverSessionResultId) {\n                    // Remove pending penalties for this driver\n                    setPendingPenaltyAdds(pendingPenaltyAdds.filter(p => {\n                      return p.driverSessionResultId !== driverSessionResultId;\n                    }));\n                    \n                    // Remove pending removals for this driver\n                    setPendingPenaltyRemovals(pendingPenaltyRemovals.filter(r => {\n                      return r.driverSessionResultId !== driverSessionResultId;\n                    }));\n                  }\n                  \n                  setPenaltyModalOpen(false);\n                  setSelectedDriver(null);\n                  setPenaltySeconds('5');\n                  setPenaltyReason('');\n                }}\n                className=\"px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors\"\n              >\n                Cancel\n              </button>\n              {(pendingPenaltyAdds.length > 0 || pendingPenaltyRemovals.some(r => {\n                const driverSessionResultId = getDriverSessionResultId(selectedDriver);\n                return driverSessionResultId && r.driverSessionResultId === driverSessionResultId;\n              })) && (\n                <button\n                  onClick={handleApplyPenalties}\n                  className=\"px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors\"\n                  title=\"Close modal and keep changes pending (save with main Save button)\"\n                >\n                  Done\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n    </DashboardPage>\n  );\n};"],"names":["RaceDetail","raceId","onDriverSelect","isAuthenticated","useAdmin","searchParams","setSearchParams","useSearchParams","sessionFromUrl","activeSession","setActiveSession","useState","raceData","setRaceData","drivers","setDrivers","sessions","setSessions","loading","setLoading","error","setError","isEditing","setIsEditing","penaltyModalOpen","setPenaltyModalOpen","selectedDriver","setSelectedDriver","penaltySeconds","setPenaltySeconds","penaltyReason","setPenaltyReason","penaltiesByDriver","setPenaltiesByDriver","pendingPenaltyAdds","setPendingPenaltyAdds","pendingPenaltyRemovals","setPendingPenaltyRemovals","driverOptions","setDriverOptions","driverOptionsLoadedRef","useRef","driverOptionsLoading","setDriverOptionsLoading","mappingBusy","setMappingBusy","mappingErrors","setMappingErrors","apiUrl","getApiUrl","normalizePenalties","useCallback","penalties","driverSessionResultId","list","penalty","a","b","useEffect","fetchRaceData","fetchDriverOptions","response","data","options","driver","logger","sessionTypes","useMemo","s","handleSessionChange","session","prev","newParams","hasRace","hasQualifying","hasPractice","findMatchingSession","targetSessionType","matchingSessions","currentSession","transformedDrivers","result","index","additionalData","visualTireCompound","raceTiresUsed","_a","_b","fc","stints","participantData","aiIndicators","aiControlled","indicator","normalized","rawDriverSessionResultId","normalizedDriverSessionResultId","rawSessionResultId","normalizedSessionResultId","mappedUserId","mappedUserName","jsonDriverName","fallbackMappingName","jsonDriverId","rawDriverId","normalizedDriverId","canonicalDriverId","normalizedResultId","preferredDisplayName","isHumanDriver","driversWithGaps","leaderTimeMs","driverTimeMs","F123DataService","gapMs","poleTime","updateDriversFromSessions","map","normalizedPenalties","fetchSessionPenalties","sessionId","grouped","rawPenalties","fetchDriverPenalties","updated","raceResponse","raceDataResult","resultsResponse","resultsData","getTeamColorHex","team","getPositionBadgeClass","position","getDriverSessionResultId","rawId","getCanonicalDriverIdentifier","raw","sessionResultIdCounts","counts","sessionResultId","duplicateSessionResultIds","duplicates","id","count","handleDriverClick","buildDriverRowKey","row","canonicalId","fallbackName","uniqueRowId","handleDriverMappingChange","nextUserId","normalizedNextUserId","option","selectedOption","nextDisplayName","prevSessions","updatedResults","next","message","penaltyMap","driverId","cloned","removal","pending","existing","pendingPenalty","usedMappedUserIds","ids","mappedId","renderDriverCell","_","currentMappedIdValue","isSaving","errorMessage","combinedOptions","jsxs","jsx","event","optionDisabled","labelParts","Fragment","ArrowUp","ArrowDown","Minus","fastestSectors","min","d","time","fastestS1","fastestS2","fastestS3","driverHasExistingPenalties","p","formatRaceTotalTime","totalTimeMs","renderPenaltyCell","buttonColor","e","totalPenalties","tooltip","renderRaceTiresCell","tiresUsed","tireStrings","t","getTireCompound","tireStr","idx","icon","fullName","label","renderQualifyingTireCell","tire","tireValue","getDriverPenalties","aDate","handleAddPenaltyToPending","seconds","newPenalty","handleRemovePendingPenalty","handleApplyPenalties","handleSaveAllChanges","handleCancelEdit","handleRemovePenaltyById","r","distanceLabel","lapsLabel","heroTitle","heroSubtitle","heroDescription","heroBase","viewState","heroStatus","isQualifyingSession","baseHeaderPadding","baseCellPadding","tableColumns","clsx","positionValue","teamColor","value","isFastest","tableEmptyMessage","DashboardPage","Edit","DashboardTable","committedPenalties","pendingAddsForDriver","X"],"mappings":"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"}