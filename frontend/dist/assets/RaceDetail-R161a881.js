import{f as jt,n as wt,r as l,g as Tt,l as N,F as x,j as a,k as m,i as It,D as Ct,X as Be}from"./index-446XYAQp.js";import{a as Ge}from"./f123DataMapping-DL4nWXCf.js";import{A as Pt,a as Rt,M as $t}from"./minus-Pc5ay-Je.js";import{P as Dt}from"./pen-square-DHzjR_mT.js";const Ut=({raceId:O,onDriverSelect:ge})=>{var Ae,Me;const{isAuthenticated:L}=jt(),[Oe,fe]=wt(),M=Oe.get("session"),[u,xe]=l.useState(M&&["practice","qualifying","race"].includes(M)?M:"race"),[p,ze]=l.useState(null),[P,ee]=l.useState([]),[k,te]=l.useState([]),[Ve,he]=l.useState(!0),[be,Je]=l.useState(null),[S,se]=l.useState(!1),[Qe,z]=l.useState(!1),[R,V]=l.useState(null),[ae,E]=l.useState("5"),[ne,q]=l.useState(""),[ye,J]=l.useState({}),[j,$]=l.useState([]),[I,F]=l.useState([]),[U,He]=l.useState([]),re=l.useRef(!1),[K,_e]=l.useState(!1),[W,ie]=l.useState({}),[ke,X]=l.useState({}),w=Tt(),B=l.useCallback((e,t)=>{let s=e;if(typeof s=="string")try{s=JSON.parse(s)}catch{s=[]}return Array.isArray(s)||(s=[]),s.map(r=>({id:r.id,driverSessionResultId:t,seconds:Number(r.seconds)||0,reason:r.reason??null,createdAt:r.created_at||r.createdAt||new Date().toISOString(),createdBy:r.created_by??r.createdBy??null})).sort((r,n)=>new Date(n.createdAt).getTime()-new Date(r.createdAt).getTime())},[]);l.useEffect(()=>{le()},[O]);const Ne=l.useCallback(async()=>{if(!(re.current||K)){_e(!0);try{const e=await fetch(`${w}/api/drivers`);if(!e.ok)throw new Error(`Failed to fetch drivers: ${e.status}`);const t=await e.json(),r=(Array.isArray(t.drivers)?t.drivers:[]).map(n=>({id:String(n.id),name:n.name??"Unknown Driver",number:n.number??null,team:n.team??null}));He(r),re.current=!0}catch(e){N.error("Error fetching driver options:",e)}finally{_e(!1)}}},[w,K]);l.useEffect(()=>{!L||!S||re.current||Ne()},[L,S,Ne]);const D=l.useMemo(()=>({hasRace:k.some(e=>e.sessionType===10),hasQualifying:k.some(e=>e.sessionType>=5&&e.sessionType<=9),hasPractice:k.some(e=>e.sessionType>=1&&e.sessionType<=4)}),[k]),C=l.useCallback(e=>{xe(e),fe(t=>{const s=new URLSearchParams(t);return s.set("session",e),s})},[fe]);l.useEffect(()=>{M&&["practice","qualifying","race"].includes(M)&&xe(M)},[M]),l.useEffect(()=>{if(k.length===0)return;const{hasRace:e,hasQualifying:t,hasPractice:s}=D;u==="race"&&!e?t?C("qualifying"):s&&C("practice"):u==="qualifying"&&!t?e?C("race"):s&&C("practice"):u==="practice"&&!s&&(e?C("race"):t&&C("qualifying"))},[k,u,D,C]);const ve=l.useCallback((e,t)=>{if(!e||e.length===0)return null;const s=t==="practice"?[1,2,3,4]:t==="qualifying"?[5,6,7,8,9]:[10],r=e.filter(n=>s.includes(n.sessionType));return r.length>0?r.sort((n,i)=>(i.sessionType||0)-(n.sessionType||0))[0]:null},[]),A=l.useMemo(()=>ve(k,u),[k,u,ve]),Y=l.useMemo(()=>!A||!A.results?[]:A.results.map((e,t)=>{var Fe,Ue;let s=null;e.additional_data?s=typeof e.additional_data=="string"?JSON.parse(e.additional_data):e.additional_data:e.additionalData&&(s=typeof e.additionalData=="string"?JSON.parse(e.additionalData):e.additionalData);let r=null,n=null;if(s){if((Fe=s.carStatus)!=null&&Fe.visualTyreCompound||(Ue=s.carStatus)!=null&&Ue["visual-tyre-compound"]?r=s.carStatus.visualTyreCompound||s.carStatus["visual-tyre-compound"]:(s.tyreVisualCompound||s["tyre-visual-compound"])&&(r=s.tyreVisualCompound||s["tyre-visual-compound"]),s.finalClassification){const f=s.finalClassification;f.tyreStintsVisual&&Array.isArray(f.tyreStintsVisual)&&f.tyreStintsVisual.length>0?n=f.tyreStintsVisual:f["tyre-stints-visual"]&&Array.isArray(f["tyre-stints-visual"])&&f["tyre-stints-visual"].length>0&&(n=f["tyre-stints-visual"])}if(!n&&(s.tyreStintsVisual||s["tyre-stints-visual"])){const f=s.tyreStintsVisual||s["tyre-stints-visual"];Array.isArray(f)&&f.length>0&&(n=f)}}const i=(s==null?void 0:s.participantData)||(s==null?void 0:s.participant_data)||(s==null?void 0:s.ParticipantData)||null,o=[i==null?void 0:i["ai-controlled"],i==null?void 0:i.aiControlled,i==null?void 0:i.ai_controlled,i==null?void 0:i.isAiControlled,i==null?void 0:i.isAI,e.ai_controlled,e.aiControlled,e.is_ai_controlled];let c=null;for(const f of o)if(f!=null){if(typeof f=="boolean"){c=f;break}if(typeof f=="number"){c=f===1;break}if(typeof f=="string"){const Le=f.trim().toLowerCase();if(["true","1","yes","y","ai"].includes(Le)){c=!0;break}if(["false","0","no","n","human"].includes(Le)){c=!1;break}}}const d=(e==null?void 0:e.driver_session_result_id)??(e==null?void 0:e.driverSessionResultId)??(e==null?void 0:e.id)??null,v=d!=null?String(d):null,h=(e==null?void 0:e.session_result_id)??(e==null?void 0:e.sessionResultId)??null,g=h!=null?String(h):null,G=e.user_id?String(e.user_id):null,T=e.driver_name||null,ue=e.json_driver_name||null,Ee=e.mapping_driver_name||null,_t=e.json_driver_id?String(e.json_driver_id):null,pe=e.driver_id??e.driverId??null,kt=pe!=null?String(pe):null,Nt=G??_t??kt??(e.member_id?String(e.member_id):null)??(e.player_id?String(e.player_id):null)??(e.driver_number!=null?`car-${e.driver_number}`:null),qe=v??((e==null?void 0:e.id)!==void 0&&(e==null?void 0:e.id)!==null?String(e.id):null)??g,vt=T||ue||Ee||"Unknown Driver",St=c===null?!!G:!c;return{id:v??qe??`driver-${v??t}`,driver_session_result_id:v,user_id:e.user_id,json_driver_id:e.json_driver_id?String(e.json_driver_id):null,mappedUserId:G,mappedUserName:T,jsonDriverName:ue,mappingDriverName:Ee,isHumanDriver:St,participantIsAi:c,sessionResultId:qe??g??null,canonicalDriverId:Nt??null,name:vt,team:e.json_team_name||e.mapping_team_name||e.driver_team||"Unknown Team",number:e.json_car_number||e.driver_number||e.mapping_driver_number||e.position||0,additional_data:s,additionalData:s,racePosition:e.position!=null?Number(e.position):null,_totalRaceTimeMs:e.total_race_time_ms!=null?Number(e.total_race_time_ms):null,raceLapTime:e.best_lap_time_ms!=null?Number(e.best_lap_time_ms):null,raceBestLapTime:e.best_lap_time_ms!=null?Number(e.best_lap_time_ms):null,raceSector1Time:e.sector1_time_ms!=null?Number(e.sector1_time_ms):null,raceSector2Time:e.sector2_time_ms!=null?Number(e.sector2_time_ms):null,raceSector3Time:e.sector3_time_ms!=null?Number(e.sector3_time_ms):null,qualifyingPosition:e.position!=null?Number(e.position):null,qualifyingTime:e.best_lap_time_ms!=null?Number(e.best_lap_time_ms):null,qualifyingBestLapTime:e.best_lap_time_ms!=null?Number(e.best_lap_time_ms):null,qualifyingSector1Time:e.sector1_time_ms!=null?Number(e.sector1_time_ms):null,qualifyingSector2Time:e.sector2_time_ms!=null?Number(e.sector2_time_ms):null,qualifyingSector3Time:e.sector3_time_ms!=null?Number(e.sector3_time_ms):null,qualifyingTire:r||e.qualifying_tire||e.best_lap_tire||e.tire_compound||null,raceTiresUsed:n||e.race_tires_used||e.tires_used||null,points:e.points!=null?Number(e.points):0,fastestLap:e.fastest_lap===!0||e.fastest_lap==="true"||e.fastest_lap===1,fastestLapTime:e.best_lap_time_ms!=null?Number(e.best_lap_time_ms):null,status:e.result_status===2||e.result_status==="2"?"finished":e.result_status===4||e.result_status==="4"?"dnf":e.result_status===5||e.result_status==="5"?"dsq":e.result_status===7||e.result_status==="7"?"dnf":e.result_status===6||e.result_status==="6"?"dnq":"finished",gridPosition:e.grid_position!=null?Number(e.grid_position):null,penalties:e.penalties!=null?Number(e.penalties):0,postRacePenalties:e.post_race_penalties!=null?Number(e.post_race_penalties):0,totalPenalties:(e.penalties||0)+(e.post_race_penalties||0),penaltyReason:e.penalty_reason||e.all_penalty_reasons||null,warnings:e.warnings!=null?Number(e.warnings):0,dnf:!!(e.result_status===4||e.result_status===7||e.dnf_reason),dnfReason:e.dnf_reason,lap_times:e.lap_times||[],dataSource:"FILE_UPLOAD"}}),[A]),Se=l.useMemo(()=>{if(Y.length===0)return Y;const e=Y.map(t=>({...t}));if(u==="race"&&e.length>0){const t=e[0]._totalRaceTimeMs||0;e.forEach((s,r)=>{const n=s._totalRaceTimeMs||0;if(r===0)s.raceTime=n>0?x.formatTimeFromMs(n):"--:--.---",s.raceGap=null,s._raceTimeFormatted=!0;else if(t>0&&n>0){const i=n-t;i>=0?(s.raceTime=`+${x.formatGapTimeFromMs(i)}`,s.raceGap=i):(s.raceTime="--:--.---",s.raceGap=null),s._raceTimeFormatted=!0}else s.raceTime="--:--.---",s.raceGap=null,s._raceTimeFormatted=!0;s.gridPosition!=null&&s.racePosition!=null?s.positionGain=s.gridPosition-s.racePosition:s.positionGain=null})}if((u==="qualifying"||u==="practice")&&e.length>0){const t=e[0].qualifyingTime||0;e.forEach(s=>{s.qualifyingTime&&s.qualifyingTime>t&&(s.qualifyingGap=s.qualifyingTime-t)})}return e},[Y,u]),je=l.useCallback(()=>{ee(Se)},[Se]);l.useEffect(()=>{je()},[je]),l.useEffect(()=>{if(!k||k.length===0){J({});return}const e=A;if(!e||!e.results){J({});return}const t={};e.results.forEach(s=>{const r=s.id||s.driver_session_result_id;if(!r)return;const n=s.penalty_details??s.penaltyDetails??[],i=B(n,r);i.length>0&&(t[r]=i)}),J(t)},[A,B]);const Q=l.useCallback(async()=>{if(!k||k.length===0)return;const e=A,t=(e==null?void 0:e.id)||(e==null?void 0:e.sessionId);if(t)try{const s=await fetch(`${w}/api/races/sessions/${t}/penalties`);if(s.ok){const r=await s.json(),n=Array.isArray(r.penalties)?r.penalties:[],i={};n.forEach(c=>{const d=c.driver_session_result_id;d&&(i[d]||(i[d]=[]),i[d].push(c))});const o={};Object.entries(i).forEach(([c,d])=>{const v=B(d,c);v.length>0&&(o[c]=v)}),J(o)}}catch(s){N.error("Error fetching session penalties:",s)}},[A,B,w]),Ke=l.useCallback(async e=>{if(e)try{const t=await fetch(`${w}/api/races/driver-results/${e}/penalties`);if(!t.ok){N.error("Failed to fetch driver penalties:",t.status,t.statusText);return}const s=await t.json(),r=Array.isArray(s.penalties)?s.penalties:[],n=B(r,e);J(i=>{const o={...i};return n.length===0?delete o[e]:o[e]=n,o})}catch(t){N.error("Error fetching driver penalties:",t)}},[B]);l.useEffect(()=>{S&&k.length>0&&(Q(),$([]),F([]))},[S,u,k,Q]);const le=async()=>{try{he(!0);const e=await fetch(`${w}/api/races/${O}`);if(e.ok){const s=await e.json();ze(s.race)}const t=await fetch(`${w}/api/races/${O}/results`);if(t.ok){const s=await t.json();te(s.sessions||[])}}catch(e){N.error("Error fetching race data:",e),Je("Failed to load race data")}finally{he(!1)}},We=e=>x.getTeamColorHex(e),Xe=e=>e===1?"inline-flex items-center rounded-full bg-amber-500/15 px-3 py-1 text-xs font-semibold text-amber-500 2xl:text-sm":e===2?"inline-flex items-center rounded-full bg-slate-400/15 px-3 py-1 text-xs font-semibold text-slate-400 2xl:text-sm":e===3?"inline-flex items-center rounded-full bg-orange-400/15 px-3 py-1 text-xs font-semibold text-orange-400 2xl:text-sm":"inline-flex items-center rounded-full bg-slate-900/10 px-3 py-1 text-xs font-semibold text-slate-600 dark:bg-slate-700/40 dark:text-slate-300 2xl:text-sm",_=e=>{const t=e.driver_session_result_id??e.driverSessionResultId??e.id??e.id??e.sessionResultId??null;if(t==null)return null;const s=String(t).trim();return s.length>0?s:null},we=e=>{const t=e.canonicalDriverId??e.mappedUserId??e.json_driver_id??(e==null?void 0:e.jsonDriverId)??(e==null?void 0:e.driver_id)??(e==null?void 0:e.driverId)??(e.user_id!=null?String(e.user_id):null)??(e.number!=null?`car-${e.number}`:null);if(t==null)return null;const s=String(t).trim();return s.length>0?s:null},Te=l.useMemo(()=>{const e={};return P.forEach(t=>{const s=_(t);s&&(e[s]=(e[s]??0)+1)}),e},[P]),Ie=l.useMemo(()=>{const e=new Set;return Object.entries(Te).forEach(([t,s])=>{s>1&&e.add(t)}),e},[Te]),Ye=l.useCallback(e=>{const t=_(e);if(!t){N.warn("Cannot navigate: missing driver_session_result_id for driver:",e.name);return}ge(t,O,u)},[u,ge,O]),Ze=l.useCallback((e,t)=>{const s=_(e);if(s){if(Ie.has(s)){const o=we(e),c=e.name&&typeof e.name=="string"?e.name.replace(/\s+/g,"-").toLowerCase():`driver-${t}`;return`${s}-${o??c}-${t}-${u}`}return`${s}-${u}`}const r=e.id!=null?String(e.id):null,n=we(e),i=e.name&&typeof e.name=="string"?e.name.replace(/\s+/g,"-").toLowerCase():`driver-${t}`;return r?`${r}-${u}`:n?`${n}-${u}`:`${i}-${t}-${u}`},[u,Ie]),Ce=l.useCallback(async(e,t)=>{var i;const s=_(e);if(!s)return;const r=t?String(t):null;if((e.mappedUserId??e.user_id??(e==null?void 0:e.mappedUserId)??(e==null?void 0:e.user_id)??null??"")!==(r??"")&&!W[s]){ie(o=>({...o,[s]:!0})),X(o=>({...o,[s]:null}));try{const o=await fetch(`${w}/api/races/driver-results/${s}/mapping`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:r,editedBy:"admin",reason:r?`Mapped to ${((i=U.find(h=>h.id===r))==null?void 0:i.name)??"league driver"}`:"Cleared driver mapping"})}),c=await o.json();if(o.status===409)throw new Error(c.error||"That league driver is already mapped to another result. Unassign them first.");if(!o.ok||!c.success)throw new Error(c.error||c.details||"Failed to update driver mapping");const d=r?U.find(h=>h.id===r)??null:null,v=(d==null?void 0:d.name)??e.mappedUserName??e.jsonDriverName??e.mappingDriverName??e.name;ee(h=>h.map(g=>_(g)!==s?g:{...g,user_id:r,mappedUserId:r,mappedUserName:(d==null?void 0:d.name)??null,canonicalDriverId:r??g.json_driver_id??(g==null?void 0:g.jsonDriverId)??g.canonicalDriverId??null,name:v,driver_session_result_id:g.driver_session_result_id??_(g)})),te(h=>h.map(g=>{if(!Array.isArray(g==null?void 0:g.results))return g;const G=g.results.map(T=>((T==null?void 0:T.id)||(T==null?void 0:T.driver_session_result_id))!==s?T:{...T,user_id:r,driver_name:(d==null?void 0:d.name)??null});return{...g,results:G}})),X(h=>{const g={...h};return delete g[s],g})}catch(o){const c=o instanceof Error?o.message:"Failed to update driver mapping";X(d=>({...d,[s]:c}))}finally{ie(o=>{const c={...o};return delete c[s],c})}}},[w,U,W,ee,te]),Z=l.useMemo(()=>{const e=new Map;return Object.entries(ye).forEach(([t,s])=>{const r=s.map(n=>({...n,isRemovalPending:I.some(i=>i.penaltyId===n.id)}));e.set(t,r)}),j.forEach(t=>{const s=e.get(t.driverSessionResultId)??[],r={id:t.id,driverSessionResultId:t.driverSessionResultId,seconds:t.seconds,reason:t.reason,createdAt:new Date().toISOString(),createdBy:"pending",isPending:!0};e.set(t.driverSessionResultId,[...s,r])}),e},[ye,j,I]),Pe=l.useMemo(()=>{const e=new Set;return P.forEach(t=>{const s=t.mappedUserId??t.user_id??(t==null?void 0:t.mappedUserId)??(t==null?void 0:t.user_id)??null;s&&e.add(String(s))}),e},[P]),et=l.useCallback((e,t)=>{const s=_(t),r=t.mappedUserId??t.user_id??(t==null?void 0:t.mappedUserId)??(t==null?void 0:t.user_id)??null,n=r??"",i=s!=null&&!!W[s],o=s!=null?ke[s]:null,c=r&&!U.some(d=>d.id===String(r))?[...U,{id:String(r),name:t.mappedUserName??t.jsonDriverName??(t==null?void 0:t.json_driver_name)??"Mapped Driver",number:null,team:null}]:U;return a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-base font-semibold text-slate-900 dark:text-slate-100",children:t.name}),L&&S&&s&&a.jsxs("select",{className:"rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 transition hover:border-slate-400 focus:border-red-600 focus:outline-none focus:ring-0 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:border-slate-600 dark:focus:border-red-400",value:n,disabled:i||K,onChange:d=>{Ce(t,d.target.value||null)},children:[a.jsx("option",{value:"",children:"Unassigned"}),c.map(d=>{const v=d.id!==n&&Pe.has(d.id),h=[d.name,d.number!=null?`#${d.number}`:null,d.team??null].filter(Boolean);return a.jsx("option",{value:d.id,disabled:v,children:h.join(" â€¢ ")},d.id)})]}),i&&a.jsx("span",{className:"text-[10px] text-slate-400 dark:text-slate-500",children:"Savingâ€¦"})]}),u==="race"&&t.positionGain!=null&&a.jsx("div",{className:"flex items-center space-x-1",children:t.positionGain>0?a.jsxs(a.Fragment,{children:[a.jsx(Pt,{className:"h-4 w-4 text-green-600 dark:text-green-400"}),a.jsx("span",{className:"text-sm text-green-600 dark:text-green-400",children:t.positionGain})]}):t.positionGain<0?a.jsxs(a.Fragment,{children:[a.jsx(Rt,{className:"h-4 w-4 text-red-600 dark:text-red-400"}),a.jsx("span",{className:"text-sm text-red-600 dark:text-red-400",children:Math.abs(t.positionGain)})]}):a.jsxs(a.Fragment,{children:[a.jsx($t,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"}),a.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:"0"})]})})]}),o&&L&&S&&a.jsx("div",{className:"mt-1 text-xs text-red-500 dark:text-red-400",children:o})]})},[u,U,K,Ce,L,S,W,ke,Pe]);l.useEffect(()=>{S||(X({}),ie({}))},[S]);const oe=l.useMemo(()=>({s1:P.reduce((e,t)=>{const s=t.qualifyingSector1Time;return s&&s<e?s:e},1/0),s2:P.reduce((e,t)=>{const s=t.qualifyingSector2Time;return s&&s<e?s:e},1/0),s3:P.reduce((e,t)=>{const s=t.qualifyingSector3Time;return s&&s<e?s:e},1/0)}),[P]),Re=oe.s1,$e=oe.s2,De=oe.s3,tt=l.useCallback(e=>{const t=_(e);return t?(e.postRacePenalties||0)>0||(Z.get(t)||[]).some(i=>!i.isRemovalPending)?!0:j.some(i=>i.driverSessionResultId===t):!1},[Z,j]),st=e=>{if(e._raceTimeFormatted&&e.raceTime)return e.raceTime;const t=e._totalRaceTimeMs;return t&&t>0?x.formatTimeFromMs(t):"--:--.---"},at=e=>{if(S){const r=tt(e)?"text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/40 hover:text-red-700 dark:hover:text-red-300 border-red-300 dark:border-red-700 hover:border-red-500 dark:hover:border-red-500":"text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/40 hover:text-blue-700 dark:hover:text-blue-300 border-blue-300 dark:border-blue-700 hover:border-blue-500 dark:hover:border-blue-500";return a.jsx("div",{className:"flex items-center justify-center",children:a.jsx("button",{onClick:async n=>{n.stopPropagation(),N.debug("ðŸ” CLICKED ADD BUTTON - Driver object:",{driver:e,driver_keys:Object.keys(e),has_additional_data:!!e.additional_data,has_additionalData:!!e.additionalData,additional_data_sample:e.additional_data?JSON.stringify(e.additional_data).substring(0,200):"MISSING",additionalData_sample:e.additionalData?JSON.stringify(e.additionalData).substring(0,200):"MISSING"}),V(e),E("5"),q(""),$([]),F([]),z(!0);const i=_(e);i?await Ke(i):await Q()},className:`px-3 py-1.5 rounded-lg text-sm font-medium border transition-all duration-200 ${r}`,children:"Add"})})}const t=e.totalPenalties;if(t!=null&&t>0){const s=e.penaltyReason;return a.jsxs("div",{className:"relative inline-block group",onMouseEnter:r=>{const n=r.currentTarget.querySelector(".penalty-tooltip");n&&(n.style.opacity="1",n.style.visibility="visible")},onMouseLeave:r=>{const n=r.currentTarget.querySelector(".penalty-tooltip");n&&(n.style.opacity="0",n.style.visibility="hidden")},children:[a.jsxs("span",{className:"text-base font-normal text-red-600 dark:text-red-400 cursor-help underline decoration-dotted",children:[t,"s"]}),s&&a.jsxs("div",{className:"penalty-tooltip absolute bottom-full left-1/2 z-50 -translate-x-1/2 transform whitespace-nowrap rounded bg-gray-900 px-2 py-1 text-xs text-white opacity-0 shadow-lg transition-all duration-200 dark:bg-gray-700",children:[s,a.jsx("div",{className:"absolute top-full left-1/2 -mt-1 -translate-x-1/2 transform border-4 border-transparent border-t-gray-900 dark:border-t-gray-700"})]})]})}return a.jsx("span",{className:"text-base text-gray-500 dark:text-gray-400",children:"-"})},nt=e=>{const t=e.raceTiresUsed;if(!t||Array.isArray(t)&&t.length===0)return a.jsx("span",{className:"text-lg text-gray-500 dark:text-gray-400",children:"-"});if(Array.isArray(t)){const i=t.map(o=>{if(typeof o=="number")return Ge(o);const c=String(o).toLowerCase();return c.includes("soft")?"S":c.includes("medium")?"M":c.includes("hard")?"H":c.includes("intermediate")?"I":c.includes("wet")?"W":String(o)});return a.jsx("div",{className:"flex items-center justify-center gap-1",children:i.map((o,c)=>{const d=x.getTireCompoundIcon(o),v=x.getTireCompoundFullName(o),h=x.getTireCompoundText(o);return d?a.jsx("img",{src:d,alt:`${v} tire`,className:"h-6 w-6"},`${o}-${c}`):a.jsx("span",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:h},`${o}-${c}`)})})}const s=x.getTireCompoundIcon(t),r=x.getTireCompoundFullName(t),n=x.getTireCompoundText(t);return s?a.jsx("div",{className:"flex items-center justify-center",children:a.jsx("img",{src:s,alt:`${r} tire`,className:"h-6 w-6"})}):a.jsx("span",{className:"text-lg text-gray-900 dark:text-white",children:n})},rt=e=>{const t=e.qualifyingTire;if(!t)return a.jsx("span",{className:"text-lg text-gray-500 dark:text-gray-400",children:"-"});const s=typeof t=="number"?Ge(t):t,r=x.getTireCompoundIcon(s),n=x.getTireCompoundText(s),i=x.getTireCompoundFullName(s);return r?a.jsx("div",{className:"flex items-center justify-center",children:a.jsx("img",{src:r,alt:`${i} tire`,className:"h-6 w-6"})}):a.jsx("span",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:n})},it=l.useCallback(e=>{const t=_(e);return t?[...Z.get(t)||[]].sort((r,n)=>{const i=new Date(r.createdAt).getTime();return new Date(n.createdAt).getTime()-i}):[]},[Z]),lt=()=>{if(!R){alert("No driver selected");return}if(!ae||!ne.trim()){alert("Please enter penalty seconds and reason");return}const e=parseFloat(ae);if(isNaN(e)||e<=0){alert("Penalty seconds must be a positive number");return}const t=_(R);if(!t){alert("Unable to identify driver. Missing driver_session_result_id.");return}const s={seconds:e,reason:ne.trim(),id:`pending-${Date.now()}-${Math.random()}`,driverSessionResultId:t};$([...j,s]),E("5"),q("")},ot=e=>{$(j.filter(t=>t.id!==e))},dt=()=>{z(!1),V(null),E("5"),q("")},ct=async()=>{try{for(const e of j){if(!e.driverSessionResultId){N.warn("Skipping penalty with missing driverSessionResultId:",e);continue}const t=await fetch(`${w}/api/races/driver-results/${e.driverSessionResultId}/penalties`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({penaltySeconds:e.seconds,reason:e.reason,editedBy:"admin"})}),s=await t.json();if(!t.ok||!s.success)throw new Error(s.error||s.details||"Failed to add penalty")}for(const e of I){if(!e.penaltyId){N.warn("Skipping removal with missing penaltyId:",e);continue}if(!e.driverSessionResultId){N.warn("Skipping removal with missing driverSessionResultId:",e);continue}N.debug(`Removing penalty: ${e.penaltyId}, driverSessionResultId: ${e.driverSessionResultId}`);const t=await fetch(`${w}/api/races/driver-results/${e.driverSessionResultId}/penalties/${e.penaltyId}`,{method:"DELETE"}),s=await t.json();if(!t.ok||!s.success)throw new Error(s.error||s.details||"Failed to remove penalty")}await Q(),await le(),se(!1),$([]),F([])}catch(e){N.error("Error saving changes:",e),alert(`Failed to save changes: ${e instanceof Error?e.message:"Unknown error"}`)}},mt=async()=>{N.debug("Canceling edit mode - discarding all pending changes:",{pendingPenaltyAdds:j.length,pendingPenaltyRemovals:I.length}),$([]),F([]),z(!1),V(null),E("5"),q(""),se(!1),await le(),await Q()},ut=(e,t)=>{const s=_(e);if(!s)return;if(t.isPending){$(j.filter(n=>n.id!==t.id));return}if(I.some(n=>n.penaltyId===t.id)){F(I.filter(n=>n.penaltyId!==t.id));return}F([...I,{penaltyId:t.id,driverSessionResultId:s}]),N.debug("Added penalty to pending removals:",{penaltyId:t.id,driverSessionResultId:s,totalPending:I.length+1})},de=(Ae=p==null?void 0:p.track)!=null&&Ae.length?`${p.track.length} km`:"Distance TBD",ce=(p==null?void 0:p.laps)!=null?`${p.laps} laps`:"Laps TBD",pt=(p==null?void 0:p.trackName)??"Race Overview",gt="Race Results",ft=p!=null&&p.raceDate?`${new Date(p.raceDate).toLocaleDateString()} â€¢ ${de} â€¢ ${ce}`:`${de} â€¢ ${ce}`,xt={imageSrc:"/raw/images/SI202510260512-Aangepast.jpg",title:pt,subtitle:gt,description:ft};(Me=p==null?void 0:p.track)!=null&&Me.length&&`${p.track.length}`,(p==null?void 0:p.laps)!=null&&`${p.laps}`;const H=Ve?"loading":be?"error":p?"ready":"empty",ht=(()=>{switch(H){case"loading":return a.jsx("div",{className:"rounded-full border border-white/25 px-5 py-2 text-xs font-semibold uppercase tracking-[0.4em] text-white/70 backdrop-blur",children:"Loading Race Data"});case"error":return a.jsx("div",{className:"rounded-full border border-red-400/60 px-5 py-2 text-xs font-semibold uppercase tracking-[0.4em] text-red-200 backdrop-blur",children:"Error Loading Race"});case"empty":return a.jsx("div",{className:"rounded-full border border-white/20 px-5 py-2 text-xs font-semibold uppercase tracking-[0.4em] text-white/70 backdrop-blur",children:"Awaiting Selection"});default:return}})(),bt=u==="qualifying"||u==="practice",b="px-3 py-3 2xl:px-4 2xl:py-3",y="px-3 py-3 2xl:px-4 2xl:py-3",me=[{key:"position",label:"Pos",align:"center",headerClassName:m(b,"w-16"),className:m(y,"w-16"),render:(e,t)=>{const s=bt?t.qualifyingPosition??t.position??null:t.racePosition??t.position??null;return a.jsx("div",{className:"flex justify-center",children:a.jsxs("span",{className:Xe(s),children:["P",s??"â€”"]})})}},{key:"driver",label:"Driver",align:"left",headerClassName:m(b,"text-left"),className:m(y,"w-56"),render:et},{key:"team",label:"Team",align:"left",headerClassName:m(b,"text-left"),className:m(y,"w-40"),render:(e,t)=>{const s=We(t.team);return a.jsx("span",{className:"text-base font-medium",style:{color:s},children:t.team})}}];u==="race"?me.push({key:"grid",label:"Grid",align:"center",headerClassName:m(b,"w-16"),className:m(y,"w-16 text-lg text-gray-900 dark:text-white"),render:(e,t)=>t.gridPosition!=null?t.gridPosition:"â€”"},{key:"bestLap",label:"Best Lap",align:"center",headerClassName:m(b,"w-28"),className:m(y,"w-28"),render:(e,t)=>a.jsx("span",{className:`text-lg ${t.fastestLap?"text-purple-600 dark:text-purple-400 font-semibold":"text-gray-900 dark:text-white"}`,children:t.raceBestLapTime?x.formatTimeFromMs(t.raceBestLapTime):"--:--.---"})},{key:"totalTime",label:"Total Time",align:"center",headerClassName:m(b,"w-28"),className:m(y,"w-28 text-lg text-gray-900 dark:text-white"),render:(e,t)=>st(t)},{key:"penalty",label:"Penalty",align:"center",headerClassName:m(b,"w-20"),className:m(y,"w-20"),render:(e,t)=>at(t)},{key:"status",label:"Status",align:"center",headerClassName:m(b,"w-24"),className:m(y,"w-24"),render:(e,t)=>a.jsx("span",{className:`inline-block rounded-full px-2 py-1 text-sm font-medium ${t.status==="finished"?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200":t.status==="dnf"?"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200":"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200"}`,children:t.status})},{key:"tires",label:"Tires",align:"center",headerClassName:m(b,"w-24"),className:m(y,"w-24"),render:(e,t)=>nt(t)},{key:"points",label:"Points",align:"center",headerClassName:m(b,"w-16"),className:m(y,"w-16 text-lg text-gray-900 dark:text-white"),render:(e,t)=>t.points!=null?t.points:"â€”"}):me.push({key:"time",label:"Time",align:"center",headerClassName:m(b,"w-28"),className:m(y,"w-28 text-lg text-gray-900 dark:text-white"),render:(e,t)=>t.qualifyingTime?x.formatTimeFromMs(t.qualifyingTime):"--:--.---"},{key:"gap",label:"Gap",align:"center",headerClassName:m(b,"w-24"),className:m(y,"w-24 text-lg text-gray-900 dark:text-white"),render:(e,t)=>t.qualifyingGap&&t.qualifyingGap>0?"+"+x.formatGapTimeFromMs(t.qualifyingGap):t.qualifyingPosition===1?u==="qualifying"?"Pole":"Leader":"--.---"},{key:"s1",label:"S1",align:"center",headerClassName:m(b,"w-20"),className:m(y,"w-20 text-lg font-medium"),render:(e,t)=>{const s=t.qualifyingSector1Time,r=s!=null&&s===Re&&Re!==1/0;return a.jsx("span",{className:r?"text-purple-600 dark:text-purple-400":"text-gray-900 dark:text-white",children:s?x.formatSectorTimeFromMs(s):"--.---"})}},{key:"s2",label:"S2",align:"center",headerClassName:m(b,"w-20"),className:m(y,"w-20 text-lg font-medium"),render:(e,t)=>{const s=t.qualifyingSector2Time,r=s!=null&&s===$e&&$e!==1/0;return a.jsx("span",{className:r?"text-purple-600 dark:text-purple-400":"text-gray-900 dark:text-white",children:s?x.formatSectorTimeFromMs(s):"--.---"})}},{key:"s3",label:"S3",align:"center",headerClassName:m(b,"w-20"),className:m(y,"w-20 text-lg font-medium"),render:(e,t)=>{const s=t.qualifyingSector3Time,r=s!=null&&s===De&&De!==1/0;return a.jsx("span",{className:r?"text-purple-600 dark:text-purple-400":"text-gray-900 dark:text-white",children:s?x.formatSectorTimeFromMs(s):"--.---"})}},{key:"tire",label:"Tire",align:"center",headerClassName:m(b,"w-16"),className:m(y,"w-16"),render:(e,t)=>rt(t)});const yt=u==="qualifying"?"No qualifying results available.":u==="practice"?"No practice results available.":"No race results available.";return a.jsxs(It,{hero:{...xt,content:ht},isReady:H!=="loading",contentClassName:"space-y-6",children:[H==="error"&&a.jsxs("div",{className:"rounded-3xl border border-red-500/30 bg-red-500/10 p-10 text-center text-sm text-red-200 backdrop-blur dark:border-red-400/40 dark:bg-red-500/15",children:[a.jsx("p",{className:"text-base font-semibold uppercase tracking-[0.3em]",children:"Unable to load"}),a.jsx("p",{className:"mt-2 text-sm text-red-200/80",children:be})]}),H==="empty"&&a.jsxs("div",{className:"rounded-3xl border border-dashed border-white/20 bg-white/10 p-12 text-center text-sm text-white/70 backdrop-blur dark:border-white/15 dark:bg-slate-900/50",children:[a.jsx("p",{className:"text-base font-semibold uppercase tracking-[0.3em] text-white/80",children:"No race selected"}),a.jsx("p",{className:"mt-2 text-sm text-white/65",children:"Choose a race to review classification, stints, and telemetry."})]}),H==="ready"&&a.jsxs("div",{className:"space-y-6",children:[(D.hasRace||D.hasQualifying||D.hasPractice)&&a.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[a.jsxs("div",{className:"flex h-10 items-center rounded-xl bg-slate-100 p-1 text-sm font-medium dark:bg-slate-900",children:[D.hasRace&&a.jsx("button",{onClick:()=>C("race"),className:`rounded-lg px-3 py-1 transition-colors ${u==="race"?"bg-red-600 text-white shadow-lg shadow-red-600/30":"text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-100"}`,children:"Race"}),D.hasQualifying&&a.jsx("button",{onClick:()=>C("qualifying"),className:`rounded-lg px-3 py-1 transition-colors ${u==="qualifying"?"bg-red-600 text-white shadow-lg shadow-red-600/30":"text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-100"}`,children:"Qualifying"}),D.hasPractice&&a.jsx("button",{onClick:()=>C("practice"),className:`rounded-lg px-3 py-1 transition-colors ${u==="practice"?"bg-red-600 text-white shadow-lg shadow-red-600/30":"text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-slate-100"}`,children:"Practice"})]}),L&&a.jsx(a.Fragment,{children:S?a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:mt,className:"rounded-lg border border-slate-300 px-3 py-1.5 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-200 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800",children:"Cancel"}),a.jsx("button",{onClick:ct,className:"rounded-lg bg-emerald-500 px-3 py-1.5 text-sm font-semibold text-white transition-colors hover:bg-emerald-400",children:"Save"})]}):a.jsxs("button",{onClick:()=>se(!0),className:"flex items-center gap-2 rounded-lg border border-slate-300 px-3 py-1.5 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-200 dark:border-slate-700 dark:text-slate-200 dark:hover:bg-slate-800",children:[a.jsx(Dt,{className:"w-4 h-4"}),a.jsx("span",{children:"Edit"})]})})]}),a.jsx(Ct,{columns:me,rows:P,rowKey:(e,t)=>Ze(e,t),onRowClick:S?void 0:e=>Ye(e),emptyMessage:yt})]}),Qe&&R&&a.jsx("div",{className:"modal-overlay",onClick:e=>{e.target===e.currentTarget&&(z(!1),V(null),E("5"),q(""))},children:a.jsxs("div",{className:"modal-panel max-w-md p-6 mx-4",onClick:e=>e.stopPropagation(),children:[a.jsxs("h2",{className:"text-xl font-bold text-gray-900 dark:text-white mb-4",children:["Manage Penalty - ",R.name]}),(()=>{const e=_(R),s=it(R).filter(n=>!n.isPending),r=j.filter(n=>n.driverSessionResultId===e);return a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Active Penalties"}),s.length>0?a.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:s.map(n=>a.jsxs("div",{className:"flex items-center justify-between bg-red-50 dark:bg-red-900/20 px-3 py-2 rounded border border-red-200 dark:border-red-800",children:[a.jsxs("div",{className:"flex flex-col",children:[a.jsxs("span",{className:"text-sm font-medium text-red-700 dark:text-red-300",children:[n.seconds>0?`+${n.seconds}s`:`${n.seconds}s`,a.jsx("span",{className:"font-normal",children:n.reason?` â€“ ${n.reason}`:" â€“ No reason provided"})]}),a.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Added ",new Date(n.createdAt).toLocaleString()," ",n.createdBy?`by ${n.createdBy}`:""]}),n.isRemovalPending&&a.jsx("span",{className:"mt-1 inline-flex items-center w-fit rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-semibold text-yellow-800",children:"Removal pending"})]}),a.jsx("button",{onClick:()=>{ut(R,n)},className:`text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-200 hover:bg-red-100 dark:hover:bg-red-900/40 rounded p-1 transition-colors ${n.isRemovalPending?"opacity-60":""}`,title:n.isRemovalPending?"Undo removal":"Mark for removal",children:a.jsx(Be,{size:16})})]},n.id))}):a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No existing post-race penalties"})]}),r.length>0&&a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Pending Additions"}),a.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:r.map(n=>a.jsxs("div",{className:"flex items-center justify-between bg-blue-50 dark:bg-blue-900/20 px-3 py-2 rounded border border-blue-200 dark:border-blue-800",children:[a.jsxs("span",{className:"text-sm text-blue-700 dark:text-blue-300 font-medium",children:["+",n.seconds,"s â€“ ",n.reason]}),a.jsx("button",{onClick:()=>ot(n.id),className:"text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 hover:bg-blue-100 dark:hover:bg-blue-900/40 rounded p-1 transition-colors",title:"Remove from pending",children:a.jsx(Be,{size:16})})]},n.id))})]})]})})(),a.jsxs("div",{className:"space-y-4 mb-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Penalty Seconds"}),a.jsx("input",{type:"number",min:"0.1",step:"0.1",value:ae,onChange:e=>E(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"5"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Reason"}),a.jsx("textarea",{value:ne,onChange:e=>q(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",rows:2,placeholder:"Enter reason for penalty (e.g., Track limits violation)",autoComplete:"off","data-autocomplete":"off",spellCheck:!1})]}),a.jsx("button",{onClick:lt,className:"w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors",children:"Add to List"})]}),a.jsxs("div",{className:"flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700",children:[a.jsx("button",{onClick:()=>{const e=_(R);e&&($(j.filter(t=>t.driverSessionResultId!==e)),F(I.filter(t=>t.driverSessionResultId!==e))),z(!1),V(null),E("5"),q("")},className:"px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors",children:"Cancel"}),(j.length>0||I.some(e=>{const t=_(R);return t&&e.driverSessionResultId===t}))&&a.jsx("button",{onClick:dt,className:"px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors",title:"Close modal and keep changes pending (save with main Save button)",children:"Done"})]})]})})]})};export{Ut as RaceDetail};
//# sourceMappingURL=RaceDetail-R161a881.js.map
